# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SISTEMA DE ALERTAS DE CÃMARAS V3.2 - SOLO PERSONAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# CAMBIO EN V3.2:
# â€¢ Usa binary_sensor de PERSON DETECTION (no motion)
# â€¢ Solo se activa cuando detecta PERSONAS
# â€¢ No se activa con movimiento de animales, sombras, etc.
#
# REQUISITO:
# â€¢ Habilitar "Person Detection" en las cÃ¡maras Tapo (ver docs)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ENTRADA: DETECCIÃ“N DE PERSONA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000401'
    alias: 'ğŸ“¹ Entrada - DetecciÃ³n de PERSONA V3.2'
    description: >
      Solo se activa cuando detecta una PERSONA (no movimiento genÃ©rico).

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c530ws_entrada_person_detection
        from: 'off'
        to: 'on'

    conditions: []

    actions:
      # 1. Actualizar helper (activa widget agrandado)
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_timestamp
        data:
          value: "{{ as_timestamp(now()) | int }}"

      # 2. Log
      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta de CÃ¡mara"
          message: "ENTRADA: PERSONA detectada a las {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c530ws_entrada_person_detection

      # 3. UNA SOLA notificaciÃ³n (PERSONA detectada)
      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ PERSONA en Entrada"
          message: "Se detectÃ³ una persona a las {{ now().strftime('%H:%M') }}"
          data:
            push:
              interruption-level: critical
              sound: alarm.caf
            tag: "camera_entrada_person"

      # 4. Activar sirena (5 segundos)
      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c530ws_entrada_siren
        data:
          duration: 5

      # 5. Encender floodlight
      - service: light.turn_on
        target:
          entity_id: light.tapo_c530ws_entrada_floodlight_timed
        data:
          brightness: 255

      # 6. Capturar snapshot
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c530ws_entrada_hd_stream
        data:
          filename: "/config/www/snapshots/entrada_person_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      # 7. Esperar 10 segundos
      - delay:
          seconds: 10

      # 8. Apagar sirena
      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c530ws_entrada_siren

      # 9. Reset automÃ¡tico
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "âœ… Alerta de ENTRADA (persona) finalizada"

    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # EXTERIOR: DETECCIÃ“N DE PERSONA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000402'
    alias: 'ğŸ“¹ Exterior - DetecciÃ³n de PERSONA V3.2'
    description: >
      Solo se activa cuando detecta una PERSONA (no movimiento genÃ©rico).

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c310_exterior_person_detection
        from: 'off'
        to: 'on'

    conditions: []

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "exterior"

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_timestamp
        data:
          value: "{{ as_timestamp(now()) | int }}"

      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta de CÃ¡mara"
          message: "EXTERIOR: PERSONA detectada a las {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c310_exterior_person_detection

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ PERSONA en Exterior"
          message: "Se detectÃ³ una persona a las {{ now().strftime('%H:%M') }}"
          data:
            push:
              interruption-level: critical
            tag: "camera_exterior_person"

      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c310_exterior_siren
        data:
          duration: 5

      - service: light.turn_on
        target:
          entity_id: light.tapo_c310_exterior_floodlight_timed
        data:
          brightness: 255

      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c310_exterior_hd_stream
        data:
          filename: "/config/www/snapshots/exterior_person_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      - delay:
          seconds: 10

      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c310_exterior_siren

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RESET MANUAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000403'
    alias: 'Reset Manual V3.2'
    description: Resetea alertas manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "reset"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: siren.turn_off
        target:
          entity_id:
            - siren.tapo_c530ws_entrada_siren
            - siren.tapo_c310_exterior_siren

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ”„ Sistema reseteado manualmente"

    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST MANUAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000404'
    alias: 'Test Manual V3.2'
    description: Prueba el sistema manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "test"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ§ª TEST: Simulando detecciÃ³n de PERSONA en entrada"

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸ§ª TEST: PERSONA detectada"
          message: "Esta es una notificaciÃ³n de prueba (detecciÃ³n de persona)."
          data:
            tag: "camera_test_person"

      - delay:
          seconds: 10

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "âœ… TEST finalizado"

    mode: single

