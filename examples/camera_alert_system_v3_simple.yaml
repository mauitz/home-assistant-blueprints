# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SISTEMA DE ALERTAS DE CÃMARAS V3 - VERSIÃ“N SIMPLIFICADA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Esta versiÃ³n es MÃS SIMPLE y solo requiere:
# â€¢ input_text.camera_alert_active (ya existe)
# â€¢ input_text.camera_alert_timestamp (ya existe)
#
# NO requiere:
# â€¢ input_select.camera_alert_type
# â€¢ input_datetime.camera_alert_last_trigger
#
# SE EJECUTA SIEMPRE (sin condiciÃ³n de persona)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ENTRADA: DETECCIÃ“N AUTOMÃTICA (Binary Sensor)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000201'
    alias: 'ğŸ“¹ Entrada - DetecciÃ³n SIMPLE'
    description: >
      Cuando la C530WS detecta movimiento.
      VersiÃ³n simplificada sin helpers extra.

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c530ws_entrada_motion_alarm
        from: 'off'
        to: 'on'

    conditions: []  # SIN CONDICIONES - siempre se ejecuta

    actions:
      # 1. Actualizar helper bÃ¡sico
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_timestamp
        data:
          value: "{{ as_timestamp(now()) | int }}"

      # 2. Log
      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta de CÃ¡mara"
          message: "ENTRADA: Movimiento detectado a las {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c530ws_entrada_motion_alarm

      # 3. NotificaciÃ³n
      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ Movimiento en Entrada"
          message: >-
            Se detectÃ³ movimiento en la entrada a las {{ now().strftime('%H:%M') }}.
          data:
            push:
              interruption-level: critical
              sound: alarm.caf

      # 4. Activar sirena
      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c530ws_entrada_siren
        data:
          duration: 10

      # 5. Encender floodlight
      - service: light.turn_on
        target:
          entity_id: light.tapo_c530ws_entrada_floodlight_timed
        data:
          brightness: 255

      # 6. Capturar snapshot
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c530ws_entrada_hd_stream
        data:
          filename: "/config/www/snapshots/entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      # 7. Esperar 30 segundos
      - delay:
          seconds: 30

      # 8. Apagar sirena
      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c530ws_entrada_siren

      # 9. Reset
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'entrada') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"

              - service: logbook.log
                data:
                  name: "Sistema de Alertas"
                  message: "âœ… Alerta de ENTRADA finalizada"

    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # EXTERIOR: DETECCIÃ“N POR WEBHOOK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000202'
    alias: 'ğŸ“¹ Exterior - DetecciÃ³n SIMPLE'
    description: >
      Cuando la C310 detecta movimiento (webhook).
      VersiÃ³n simplificada.

    triggers:
      - platform: webhook
        webhook_id: tapo_c310_exterior_motion_detected
        local_only: false

    conditions: []

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "exterior"

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_timestamp
        data:
          value: "{{ as_timestamp(now()) | int }}"

      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta de CÃ¡mara"
          message: "EXTERIOR: Movimiento detectado a las {{ now().strftime('%H:%M:%S') }}"
          entity_id: siren.tapo_c310_exterior_siren

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ Movimiento en Exterior"
          message: >-
            Se detectÃ³ movimiento en el exterior a las {{ now().strftime('%H:%M') }}.
          data:
            push:
              interruption-level: critical

      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c310_exterior_siren
        data:
          duration: 10

      - service: light.turn_on
        target:
          entity_id: light.tapo_c310_exterior_floodlight_timed
        data:
          brightness: 255

      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c310_exterior_hd_stream
        data:
          filename: "/config/www/snapshots/exterior_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      - delay:
          seconds: 30

      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c310_exterior_siren

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'exterior') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"

    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RESET MANUAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000203'
    alias: 'Reset Manual SIMPLE'
    description: Resetea alertas manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "reset"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: siren.turn_off
        target:
          entity_id:
            - siren.tapo_c530ws_entrada_siren
            - siren.tapo_c310_exterior_siren

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ”„ Sistema reseteado manualmente"

    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST MANUAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000204'
    alias: 'Test Manual SIMPLE'
    description: Prueba el sistema manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "test"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ§ª TEST: Simulando detecciÃ³n en entrada"

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸ§ª TEST: Alerta de CÃ¡mara"
          message: "Esta es una notificaciÃ³n de prueba del sistema de alertas."

      - delay:
          seconds: 10

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "âœ… TEST finalizado"

    mode: single

