# Automatizaciones de Presencia con SmartNode1
# Detecta presencia en la habitaci贸n usando el sensor LD2410

# ==============================================
# AUTOMATIZACIN 1: PRESENCIA DETECTADA
# ==============================================
# Se activa cuando el smartnode1 detecta presencia en la habitaci贸n

- id: 'habitacion_presencia_detectada'
  alias: Habitaci贸n - Presencia Detectada
  description: 'Se activa cuando el smartnode1 detecta presencia en la habitaci贸n'
  triggers:
  - trigger: state
    entity_id: binary_sensor.presence
    from: 'off'
    to: 'on'
  conditions: []
  actions:
  - action: logbook.log
    data:
      name: Habitaci贸n - Presencia
      message: "Presencia detectada en la habitaci贸n a las {{ now().strftime('%H:%M:%S') }}"

  # Notificaci贸n m贸vil
  - action: notify.mobile_app_blacky
    data:
      title: " Presencia Detectada"
      message: "Se detect贸 presencia en la habitaci贸n"
      data:
        push:
          interruption-level: active

  # Ejemplo: Encender luces solo si es de noche
  # - choose:
  #   - conditions:
  #     - condition: sun
  #       after: sunset
  #       after_offset: "-01:00:00"
  #     - condition: sun
  #       before: sunrise
  #       before_offset: "01:00:00"
  #     sequence:
  #     - action: light.turn_on
  #       target:
  #         entity_id: light.habitacion
  #       data:
  #         brightness_pct: 60
  #         transition: 1

  # Ejemplo: Activar escena espec铆fica
  # - action: scene.turn_on
  #   target:
  #     entity_id: scene.habitacion_activa

  # Ejemplo: Ajustar temperatura del aire acondicionado
  # - action: climate.set_temperature
  #   target:
  #     entity_id: climate.habitacion
  #   data:
  #     temperature: 22
  #     hvac_mode: cool

  mode: single

# ==============================================
# AUTOMATIZACIN 2: SIN PRESENCIA
# ==============================================
# Se activa cuando no hay presencia en la habitaci贸n por 5 minutos

- id: 'habitacion_sin_presencia'
  alias: Habitaci贸n - Sin Presencia
  description: 'Se activa cuando no hay presencia en la habitaci贸n por 5 minutos'
  triggers:
  - trigger: state
    entity_id: binary_sensor.presence
    from: 'on'
    to: 'off'
    for:
      minutes: 5  # Ajusta este tiempo seg煤n tus necesidades
  conditions: []
  actions:
  - action: logbook.log
    data:
      name: Habitaci贸n - Sin Presencia
      message: "No hay presencia en la habitaci贸n desde hace 5 minutos ({{ now().strftime('%H:%M:%S') }})"

  # Notificaci贸n m贸vil
  - action: notify.mobile_app_blacky
    data:
      title: " Habitaci贸n Vac铆a"
      message: "No se detecta presencia en la habitaci贸n desde hace 5 minutos"
      data:
        push:
          interruption-level: passive

  # Ejemplo: Apagar luces con transici贸n suave
  # - action: light.turn_off
  #   target:
  #     entity_id: light.habitacion
  #   data:
  #     transition: 3

  # Ejemplo: Activar escena de ahorro
  # - action: scene.turn_on
  #   target:
  #     entity_id: scene.habitacion_vacia

  # Ejemplo: Ajustar temperatura a modo eco
  # - action: climate.set_temperature
  #   target:
  #     entity_id: climate.habitacion
  #   data:
  #     temperature: 26
  #     hvac_mode: cool

  mode: restart  # Se reinicia si se detecta movimiento nuevamente

# ==============================================
# AUTOMATIZACIN 3 (AVANZADA): PRESENCIA NOCTURNA
# ==============================================
# Enciende luces tenues solo de noche cuando hay presencia

- id: 'habitacion_presencia_nocturna'
  alias: Habitaci贸n - Luz Nocturna Autom谩tica
  description: 'Enciende luces tenues cuando hay presencia durante la noche'
  triggers:
  - trigger: state
    entity_id: binary_sensor.presence
    from: 'off'
    to: 'on'
  conditions:
  # Solo actuar entre las 22:00 y las 07:00
  - condition: time
    after: '22:00:00'
    before: '07:00:00'
  actions:
  # Luz tenue para no molestar
  # - action: light.turn_on
  #   target:
  #     entity_id: light.habitacion
  #   data:
  #     brightness_pct: 15
  #     kelvin: 2200  # Luz c谩lida
  #     transition: 2

  - action: logbook.log
    data:
      name: Habitaci贸n - Modo Nocturno
      message: "Luz nocturna activada por presencia"

  mode: single

# ==============================================
# AUTOMATIZACIN 4 (AVANZADA): ALERTAS DE PRESENCIA INESPERADA
# ==============================================
# Notifica si hay presencia cuando deber铆as estar fuera

- id: 'habitacion_presencia_inesperada'
  alias: Habitaci贸n - Alerta Presencia Inesperada
  description: 'Alerta si hay presencia cuando no deber铆as estar en casa'
  triggers:
  - trigger: state
    entity_id: binary_sensor.presence
    from: 'off'
    to: 'on'
  conditions:
  # Solo si est谩s fuera de casa
  - condition: template
    value_template: '{{ (distance("device_tracker.blacky", "zone.home") | float(0)) > 0.1 }}'
  # Y no est谩 activa la simulaci贸n de presencia
  - condition: state
    entity_id: input_boolean.presence_simulation
    state: 'off'
  actions:
  # Notificaci贸n de alerta
  - action: notify.mobile_app_blacky
    data:
      title: "锔 Alerta: Presencia Detectada"
      message: "Se detect贸 presencia en la habitaci贸n mientras est谩s fuera de casa"
      data:
        push:
          interruption-level: critical
        actions:
        - action: VIEW_CAMERA
          title: Ver c谩mara
        - action: CALL_POLICE
          title: Llamar emergencias

  # Registrar en el log
  - action: logbook.log
    data:
      name: Habitaci贸n - Alerta Seguridad
      message: "Presencia detectada con usuario fuera de casa"

  mode: single

# ==============================================
# AUTOMATIZACIN 5 (AVANZADA): ESTADSTICAS DE USO
# ==============================================
# Registra cu谩nto tiempo se usa la habitaci贸n

- id: 'habitacion_estadisticas_uso'
  alias: Habitaci贸n - Registro de Uso
  description: 'Registra estad铆sticas de uso de la habitaci贸n'
  triggers:
  - trigger: state
    entity_id: binary_sensor.presence
    to: 'on'
  - trigger: state
    entity_id: binary_sensor.presence
    to: 'off'
    for:
      minutes: 5
  actions:
  - action: logbook.log
    data:
      name: Habitaci贸n - Estad铆sticas
      message: >
        Estado: {{ states('binary_sensor.presence') }}
        Temperatura: {{ states('sensor.room_temperature') }}掳C
        Humedad: {{ states('sensor.room_humidity') }}%
        Luminosidad: {{ states('sensor.room_brightness') }}%

  mode: restart

# ==============================================
# NOTAS Y PERSONALIZACIONES
# ==============================================

# SENSORES DISPONIBLES DEL SMARTNODE1:
# - binary_sensor.presence              -> Presencia general (recomendado)
# - binary_sensor.moving_target         -> Solo movimiento
# - binary_sensor.still_target          -> Presencia est谩tica
# - sensor.room_temperature             -> Temperatura
# - sensor.room_humidity                -> Humedad
# - sensor.room_brightness              -> Luminosidad
# - sensor.detection_distance           -> Distancia de detecci贸n

# TIEMPOS RECOMENDADOS PARA "for":
# - Ba帽o: 3-5 minutos
# - Habitaci贸n: 5-10 minutos
# - Sala: 10-15 minutos
# - Cocina: 5-10 minutos

# MODOS DE AUTOMATIZACIN:
# - single: No se reinicia hasta que termine
# - restart: Se reinicia si se activa nuevamente
# - queued: Cola las ejecuciones
# - parallel: M煤ltiples ejecuciones simult谩neas

