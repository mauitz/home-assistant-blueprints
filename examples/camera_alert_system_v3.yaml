# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SISTEMA DE ALERTAS DE CÃMARAS V3 - CON BINARY SENSORS REALES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# REQUISITO PREVIO: IntegraciÃ³n "Tapo: Cameras Control" instalada desde HACS
#
# Esta versiÃ³n usa binary_sensor reales de detecciÃ³n de movimiento y personas
# que genera la integraciÃ³n correcta de Tapo.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. HELPERS ADICIONALES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

input_select:
  camera_alert_type:
    name: Tipo de Ãšltima Alerta
    icon: mdi:alert-circle
    options:
      - "Ninguna"
      - "Movimiento"
      - "Persona"
    initial: "Ninguna"

input_datetime:
  camera_alert_last_trigger:
    name: Ãšltima DetecciÃ³n
    has_date: true
    has_time: true
    icon: mdi:clock-alert

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. AUTOMATIZACIONES V3
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

automation:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CÃMARA ENTRADA: DETECCIÃ“N DE PERSONA (Alta prioridad)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000001'
    alias: 'ğŸ“¹ Entrada - DetecciÃ³n de Persona'
    description: >
      Cuando la cÃ¡mara de entrada detecta una persona (no solo movimiento),
      agranda el widget, activa alarma y notifica con alta prioridad.

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c530ws_entrada_person
        from: 'off'
        to: 'on'

    conditions:
      # Solo si no estamos en casa
      - condition: state
        entity_id: person.nico
        state: 'not_home'

    actions:
      # 1. Actualizar helpers
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Persona"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.camera_alert_last_trigger
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

      # 2. Capturar snapshot
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c530ws_entrada_hd
        data:
          filename: "/config/www/snapshots/entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      # 3. Activar alarma de la cÃ¡mara (sirena/luz)
      - service: switch.turn_on
        target:
          entity_id: switch.tapo_c530ws_entrada_alarm

      # 4. Log
      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta CrÃ­tica"
          message: "PERSONA detectada en ENTRADA - {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c530ws_entrada_person

      # 5. NotificaciÃ³n con imagen
      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ PERSONA en Entrada"
          message: >-
            Se detectÃ³ una persona en la entrada a las {{ now().strftime('%H:%M') }}.
            CÃ¡mara agrandada por 60 segundos.
          data:
            image: "/local/snapshots/entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
            push:
              interruption-level: critical
              sound: alarm.caf

      # 6. Encadenar comportamiento: encender luces
      - service: scene.turn_on
        target:
          entity_id: scene.anochecer

      # 7. Esperar 60 segundos (persona = mÃ¡s tiempo)
      - delay:
          seconds: 60

      # 8. Desactivar alarma
      - service: switch.turn_off
        target:
          entity_id: switch.tapo_c530ws_entrada_alarm

      # 9. Reset si no hay nueva detecciÃ³n
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'entrada') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"

              - service: logbook.log
                data:
                  name: "Sistema de Alertas"
                  message: "âœ… Alerta de ENTRADA finalizada"

    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CÃMARA ENTRADA: DETECCIÃ“N DE MOVIMIENTO (Prioridad normal)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000002'
    alias: 'ğŸ“¹ Entrada - DetecciÃ³n de Movimiento'
    description: >
      Cuando la cÃ¡mara de entrada detecta movimiento (pero no persona),
      agranda el widget y log, sin alarma.

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c530ws_entrada_motion
        from: 'off'
        to: 'on'

    conditions:
      # Solo si NO es persona (ya tiene otra automatizaciÃ³n)
      - condition: state
        entity_id: binary_sensor.tapo_c530ws_entrada_person
        state: 'off'

    actions:
      # 1. Actualizar helpers
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Movimiento"

      # 2. Capturar snapshot
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c530ws_entrada_sd
        data:
          filename: "/config/www/snapshots/entrada_motion_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      # 3. Log
      - service: logbook.log
        data:
          name: "DetecciÃ³n de Movimiento"
          message: "Movimiento detectado en ENTRADA - {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c530ws_entrada_motion

      # 4. Esperar 30 segundos (movimiento = menos tiempo)
      - delay:
          seconds: 30

      # 5. Reset
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'entrada') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"

    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CÃMARA EXTERIOR: DETECCIÃ“N DE PERSONA (Alta prioridad)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000003'
    alias: 'ğŸ“¹ Exterior - DetecciÃ³n de Persona'
    description: >
      Cuando la cÃ¡mara exterior detecta una persona.

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c310_exterior_person
        from: 'off'
        to: 'on'

    conditions:
      - condition: state
        entity_id: person.nico
        state: 'not_home'

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "exterior"

      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Persona"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.camera_alert_last_trigger
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c310_exterior_hd
        data:
          filename: "/config/www/snapshots/exterior_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      - service: switch.turn_on
        target:
          entity_id: switch.tapo_c310_exterior_alarm

      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta CrÃ­tica"
          message: "PERSONA detectada en EXTERIOR - {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c310_exterior_person

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ PERSONA en Exterior"
          message: >-
            Se detectÃ³ una persona en el exterior a las {{ now().strftime('%H:%M') }}.
          data:
            image: "/local/snapshots/exterior_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
            push:
              interruption-level: critical

      - delay:
          seconds: 60

      - service: switch.turn_off
        target:
          entity_id: switch.tapo_c310_exterior_alarm

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'exterior') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"

    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CÃMARA EXTERIOR: DETECCIÃ“N DE MOVIMIENTO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000004'
    alias: 'ğŸ“¹ Exterior - DetecciÃ³n de Movimiento'
    description: >
      Cuando la cÃ¡mara exterior detecta movimiento (pero no persona).

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c310_exterior_motion
        from: 'off'
        to: 'on'

    conditions:
      - condition: state
        entity_id: binary_sensor.tapo_c310_exterior_person
        state: 'off'

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "exterior"

      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Movimiento"

      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c310_exterior_sd
        data:
          filename: "/config/www/snapshots/exterior_motion_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      - service: logbook.log
        data:
          name: "DetecciÃ³n de Movimiento"
          message: "Movimiento detectado en EXTERIOR - {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c310_exterior_motion

      - delay:
          seconds: 30

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'exterior') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"

    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RESET MANUAL Y LIMPIEZA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000005'
    alias: 'Reset Manual de Alertas de CÃ¡maras'
    description: Resetea el sistema de alertas manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "reset"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Ninguna"

      - service: switch.turn_off
        target:
          entity_id:
            - switch.tapo_c530ws_entrada_alarm
            - switch.tapo_c310_exterior_alarm

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ”„ Sistema reseteado manualmente"

    mode: single

