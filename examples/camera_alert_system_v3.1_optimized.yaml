# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SISTEMA DE ALERTAS DE CÃMARAS V3.1 - OPTIMIZADO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MEJORAS EN V3.1:
# â€¢ Solo UNA notificaciÃ³n por detecciÃ³n (evita spam)
# â€¢ Reset mÃ¡s rÃ¡pido: 10 segundos (antes 30s)
# â€¢ Mode: single para prevenir ejecuciones mÃºltiples
# â€¢ Dashboard con widget AGRANDADO (3 columnas)
#
# LIMITACIÃ“N:
# â€¢ Velocidad de detecciÃ³n depende del polling del binary sensor
#   (configurado en la integraciÃ³n Tapo, tÃ­picamente 1-2 segundos)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ENTRADA: DETECCIÃ“N AUTOMÃTICA (Optimizada)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000301'
    alias: 'ğŸ“¹ Entrada - DetecciÃ³n V3.1'
    description: >
      DetecciÃ³n optimizada: UNA notificaciÃ³n, reset rÃ¡pido (10s).

    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c530ws_entrada_motion_alarm
        from: 'off'
        to: 'on'

    conditions: []

    actions:
      # 1. Actualizar helper (activa widget agrandado)
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_timestamp
        data:
          value: "{{ as_timestamp(now()) | int }}"

      # 2. Log
      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta de CÃ¡mara"
          message: "ENTRADA: Movimiento detectado a las {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c530ws_entrada_motion_alarm

      # 3. UNA SOLA notificaciÃ³n (no se repite aunque se redetecte)
      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ Movimiento en Entrada"
          message: "Detectado a las {{ now().strftime('%H:%M') }}"
          data:
            push:
              interruption-level: critical
              sound: alarm.caf
            tag: "camera_entrada"  # Tag para reemplazar notificaciÃ³n existente

      # 4. Activar sirena (solo 5 segundos para no molestar)
      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c530ws_entrada_siren
        data:
          duration: 5

      # 5. Encender floodlight
      - service: light.turn_on
        target:
          entity_id: light.tapo_c530ws_entrada_floodlight_timed
        data:
          brightness: 255

      # 6. Capturar snapshot
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c530ws_entrada_hd_stream
        data:
          filename: "/config/www/snapshots/entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      # 7. Esperar solo 10 segundos (mÃ¡s rÃ¡pido)
      - delay:
          seconds: 10

      # 8. Apagar sirena
      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c530ws_entrada_siren

      # 9. Reset automÃ¡tico
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "âœ… Alerta de ENTRADA finalizada (10s)"

    mode: single  # NO permite ejecuciones simultÃ¡neas (evita spam)


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # EXTERIOR: DETECCIÃ“N POR WEBHOOK (Optimizada)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000302'
    alias: 'ğŸ“¹ Exterior - DetecciÃ³n V3.1'
    description: >
      DetecciÃ³n optimizada para C310 vÃ­a webhook.

    triggers:
      - platform: webhook
        webhook_id: tapo_c310_exterior_motion_detected
        local_only: false

    conditions: []

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "exterior"

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_timestamp
        data:
          value: "{{ as_timestamp(now()) | int }}"

      - service: logbook.log
        data:
          name: "ğŸš¨ Alerta de CÃ¡mara"
          message: "EXTERIOR: Movimiento detectado a las {{ now().strftime('%H:%M:%S') }}"
          entity_id: siren.tapo_c310_exterior_siren

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸš¨ Movimiento en Exterior"
          message: "Detectado a las {{ now().strftime('%H:%M') }}"
          data:
            push:
              interruption-level: critical
            tag: "camera_exterior"

      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c310_exterior_siren
        data:
          duration: 5

      - service: light.turn_on
        target:
          entity_id: light.tapo_c310_exterior_floodlight_timed
        data:
          brightness: 255

      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c310_exterior_hd_stream
        data:
          filename: "/config/www/snapshots/exterior_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"

      - delay:
          seconds: 10

      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c310_exterior_siren

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RESET MANUAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000303'
    alias: 'Reset Manual V3.1'
    description: Resetea alertas manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "reset"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: siren.turn_off
        target:
          entity_id:
            - siren.tapo_c530ws_entrada_siren
            - siren.tapo_c310_exterior_siren

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ”„ Sistema reseteado manualmente"

    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST MANUAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000304'
    alias: 'Test Manual V3.1'
    description: Prueba el sistema manualmente

    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "test"

    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ğŸ§ª TEST: Simulando detecciÃ³n en entrada"

      - service: notify.mobile_app_blacky
        data:
          title: "ğŸ§ª TEST: Alerta de CÃ¡mara"
          message: "Esta es una notificaciÃ³n de prueba del sistema de alertas."
          data:
            tag: "camera_test"

      - delay:
          seconds: 10

      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"

      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "âœ… TEST finalizado"

    mode: single

