# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AUTOMATIZACIONES PARA SISTEMA DE ALERTAS DE CÃMARAS V2
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Estas automatizaciones escuchan eventos de detecciÃ³n de las
# cÃ¡maras Tapo y activan el widget agrandado por 30 segundos.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. DETECCIÃ“N EN CÃMARA DE ENTRADA
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: '1763070000001'
  alias: Alerta CÃ¡mara Entrada - Agrandar
  description: >
    Cuando la cÃ¡mara de entrada detecta movimiento o persona,
    agranda el widget en el dashboard por 30 segundos.
  triggers:
    # Trigger por webhook o notificaciÃ³n de Tapo
    - platform: webhook
      webhook_id: tapo_c530ws_entrada_motion
      local_only: false

    # Trigger alternativo: monitoring del estado de la cÃ¡mara
    - platform: state
      entity_id: camera.tapo_c530ws_entrada_live_view
      from: 'idle'
      to: 'recording'

  conditions: []

  actions:
    # 1. Actualizar helper con nombre de cÃ¡mara detectada
    - service: input_text.set_value
      target:
        entity_id: input_text.camera_alert_active
      data:
        value: "entrada"

    # 2. Guardar timestamp
    - service: input_text.set_value
      target:
        entity_id: input_text.camera_alert_timestamp
      data:
        value: "{{ as_timestamp(now()) | int }}"

    # 3. Log en logbook
    - service: logbook.log
      data:
        name: Sistema de Alertas de CÃ¡maras
        message: "ðŸš¨ DetecciÃ³n en ENTRADA - Widget agrandado por 30s"
        entity_id: camera.tapo_c530ws_entrada_live_view

    # 4. Esperar 30 segundos
    - delay:
        seconds: 30

    # 5. Resetear alerta si no hay nueva detecciÃ³n
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ is_state('input_text.camera_alert_active', 'entrada') }}"
          sequence:
            - service: input_text.set_value
              target:
                entity_id: input_text.camera_alert_active
              data:
                value: "none"

            - service: logbook.log
              data:
                name: Sistema de Alertas de CÃ¡maras
                message: "âœ… Alerta de ENTRADA finalizada - Widget restaurado"

  mode: restart

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. DETECCIÃ“N EN CÃMARA EXTERIOR
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: '1763070000002'
  alias: Alerta CÃ¡mara Exterior - Agrandar
  description: >
    Cuando la cÃ¡mara exterior detecta movimiento o persona,
    agranda el widget en el dashboard por 30 segundos.
  triggers:
    # Trigger por webhook o notificaciÃ³n de Tapo
    - platform: webhook
      webhook_id: tapo_c310_exterior_motion
      local_only: false

    # Trigger alternativo: monitoring del estado de la cÃ¡mara
    - platform: state
      entity_id: camera.tapo_c310_exterior_live_view
      from: 'idle'
      to: 'recording'

  conditions: []

  actions:
    # 1. Actualizar helper con nombre de cÃ¡mara detectada
    - service: input_text.set_value
      target:
        entity_id: input_text.camera_alert_active
      data:
        value: "exterior"

    # 2. Guardar timestamp
    - service: input_text.set_value
      target:
        entity_id: input_text.camera_alert_timestamp
      data:
        value: "{{ as_timestamp(now()) | int }}"

    # 3. Log en logbook
    - service: logbook.log
      data:
        name: Sistema de Alertas de CÃ¡maras
        message: "ðŸš¨ DetecciÃ³n en EXTERIOR - Widget agrandado por 30s"
        entity_id: camera.tapo_c310_exterior_live_view

    # 4. Esperar 30 segundos
    - delay:
        seconds: 30

    # 5. Resetear alerta si no hay nueva detecciÃ³n
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ is_state('input_text.camera_alert_active', 'exterior') }}"
          sequence:
            - service: input_text.set_value
              target:
                entity_id: input_text.camera_alert_active
              data:
                value: "none"

            - service: logbook.log
              data:
                name: Sistema de Alertas de CÃ¡maras
                message: "âœ… Alerta de EXTERIOR finalizada - Widget restaurado"

  mode: restart

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. RESET MANUAL DE ALERTAS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: '1763070000003'
  alias: Alerta CÃ¡maras - Reset Manual
  description: Resetea alertas de cÃ¡maras manualmente
  triggers:
    - platform: state
      entity_id: input_text.camera_alert_active
      to: "reset"

  conditions: []

  actions:
    - service: input_text.set_value
      target:
        entity_id: input_text.camera_alert_active
      data:
        value: "none"

    - service: logbook.log
      data:
        name: Sistema de Alertas de CÃ¡maras
        message: "ðŸ”„ Alertas reseteadas manualmente"

  mode: single

