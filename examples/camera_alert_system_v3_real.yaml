# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SISTEMA DE ALERTAS DE CÃMARAS V3 - ADAPTADO A ENTIDADES REALES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Esta versiÃ³n usa las entidades REALES que genera tu integraciÃ³n Tapo.
#
# ENTIDADES DISPONIBLES:
# â€¢ binary_sensor.tapo_c530ws_entrada_motion_alarm (C530WS)
# â€¢ siren.tapo_c530ws_entrada_siren
# â€¢ siren.tapo_c310_exterior_siren
# â€¢ camera.*_hd_stream / *_sd_stream
#
# NOTA: C310 no tiene binary_sensor, se usa webhook como alternativa
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CÃMARA ENTRADA: DETECCIÃ“N DE MOVIMIENTO (Binary Sensor Real)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000101'
    alias: 'ðŸ“¹ Entrada - DetecciÃ³n (Binary Sensor)'
    description: >
      Cuando la cÃ¡mara de entrada detecta movimiento (binary sensor real).
      Agranda widget, captura snapshot, activa sirena y notifica.
    
    triggers:
      - platform: state
        entity_id: binary_sensor.tapo_c530ws_entrada_motion_alarm
        from: 'off'
        to: 'on'
    
    conditions:
      # Solo si no estamos en casa
      - condition: state
        entity_id: person.nico
        state: 'not_home'
    
    actions:
      # 1. Actualizar helpers
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"
      
      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Movimiento"
      
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.camera_alert_last_trigger
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      
      # 2. Capturar snapshot
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c530ws_entrada_hd_stream
        data:
          filename: "/config/www/snapshots/entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
      
      # 3. Activar sirena de la cÃ¡mara
      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c530ws_entrada_siren
        data:
          duration: 10  # 10 segundos
      
      # 4. Log
      - service: logbook.log
        data:
          name: "ðŸš¨ Alerta de CÃ¡mara"
          message: "Movimiento detectado en ENTRADA - {{ now().strftime('%H:%M:%S') }}"
          entity_id: binary_sensor.tapo_c530ws_entrada_motion_alarm
      
      # 5. NotificaciÃ³n con imagen
      - service: notify.mobile_app_blacky
        data:
          title: "ðŸš¨ Movimiento en Entrada"
          message: >-
            Se detectÃ³ movimiento en la entrada a las {{ now().strftime('%H:%M') }}.
            Widget agrandado por 45 segundos.
          data:
            image: "/local/snapshots/entrada_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
            push:
              interruption-level: critical
              sound: alarm.caf
      
      # 6. Encadenar comportamiento: encender luces
      - service: scene.turn_on
        target:
          entity_id: scene.anochecer
      
      # 7. Encender luz de la cÃ¡mara (floodlight)
      - service: light.turn_on
        target:
          entity_id: light.tapo_c530ws_entrada_floodlight_timed
        data:
          brightness: 255
      
      # 8. Esperar 45 segundos
      - delay:
          seconds: 45
      
      # 9. Apagar sirena
      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c530ws_entrada_siren
      
      # 10. Reset si no hay nueva detecciÃ³n
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'entrada') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"
              
              - service: logbook.log
                data:
                  name: "Sistema de Alertas"
                  message: "âœ… Alerta de ENTRADA finalizada"
    
    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CÃMARA EXTERIOR: DETECCIÃ“N VÃA WEBHOOK (Sin Binary Sensor)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000102'
    alias: 'ðŸ“¹ Exterior - DetecciÃ³n (Webhook)'
    description: >
      Cuando la cÃ¡mara exterior detecta movimiento (vÃ­a webhook manual).
      C310 no tiene binary_sensor, requiere webhook.
    
    triggers:
      - platform: webhook
        webhook_id: tapo_c310_exterior_motion_detected
        local_only: false
    
    conditions:
      - condition: state
        entity_id: person.nico
        state: 'not_home'
    
    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "exterior"
      
      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Movimiento"
      
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.camera_alert_last_trigger
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      
      - service: camera.snapshot
        target:
          entity_id: camera.tapo_c310_exterior_hd_stream
        data:
          filename: "/config/www/snapshots/exterior_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
      
      - service: siren.turn_on
        target:
          entity_id: siren.tapo_c310_exterior_siren
        data:
          duration: 10
      
      - service: logbook.log
        data:
          name: "ðŸš¨ Alerta de CÃ¡mara"
          message: "Movimiento detectado en EXTERIOR - {{ now().strftime('%H:%M:%S') }}"
          entity_id: siren.tapo_c310_exterior_siren
      
      - service: notify.mobile_app_blacky
        data:
          title: "ðŸš¨ Movimiento en Exterior"
          message: >-
            Se detectÃ³ movimiento en el exterior a las {{ now().strftime('%H:%M') }}.
          data:
            image: "/local/snapshots/exterior_{{ now().strftime('%Y%m%d_%H%M%S') }}.jpg"
            push:
              interruption-level: critical
      
      - service: light.turn_on
        target:
          entity_id: light.tapo_c310_exterior_floodlight_timed
        data:
          brightness: 255
      
      - delay:
          seconds: 45
      
      - service: siren.turn_off
        target:
          entity_id: siren.tapo_c310_exterior_siren
      
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state('input_text.camera_alert_active', 'exterior') }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.camera_alert_active
                data:
                  value: "none"
    
    mode: restart


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RESET MANUAL Y LIMPIEZA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000103'
    alias: 'Reset Manual de Alertas de CÃ¡maras'
    description: Resetea el sistema de alertas manualmente
    
    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "reset"
    
    actions:
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"
      
      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Ninguna"
      
      - service: siren.turn_off
        target:
          entity_id:
            - siren.tapo_c530ws_entrada_siren
            - siren.tapo_c310_exterior_siren
      
      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ðŸ”„ Sistema reseteado manualmente"
    
    mode: single


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST MANUAL - Para probar el sistema
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - id: '1763075000104'
    alias: 'Test Manual - Alertas de CÃ¡maras'
    description: >
      AutomatizaciÃ³n de prueba para activar alertas manualmente.
      Ãštil para testing sin esperar detecciÃ³n real.
    
    triggers:
      - platform: state
        entity_id: input_text.camera_alert_active
        to: "test"
    
    actions:
      # Simular detecciÃ³n en entrada
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "entrada"
      
      - service: input_select.select_option
        target:
          entity_id: input_select.camera_alert_type
        data:
          option: "Movimiento"
      
      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "ðŸ§ª TEST: Simulando detecciÃ³n en entrada"
      
      - service: notify.mobile_app_blacky
        data:
          title: "ðŸ§ª TEST: Alerta de CÃ¡mara"
          message: "Esta es una notificaciÃ³n de prueba del sistema de alertas."
      
      - delay:
          seconds: 15
      
      - service: input_text.set_value
        target:
          entity_id: input_text.camera_alert_active
        data:
          value: "none"
      
      - service: logbook.log
        data:
          name: "Sistema de Alertas"
          message: "âœ… TEST finalizado"
    
    mode: single

