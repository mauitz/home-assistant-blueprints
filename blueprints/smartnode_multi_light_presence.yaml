blueprint:
  name: SmartNode - Control Multi-Luz por Presencia
  description: |
    # ðŸ’¡ AutomatizaciÃ³n de MÃºltiples Luces por Presencia

    Control automÃ¡tico de mÃºltiples luces basado en presencia detectada
    por un SmartNode (LD2410) y nivel de luminosidad ambiente.

    **CaracterÃ­sticas:**
    - âœ… Control de mÃºltiples luces simultÃ¡neamente
    - âœ… Enciende solo luces apagadas al detectar presencia
    - âœ… Apagado automÃ¡tico configurable tras ausencia
    - âœ… Respeta condiciÃ³n de oscuridad (configurable)
    - âœ… LÃ­mite de distancia de detecciÃ³n (opcional)
    - âœ… Soporte para switches y luces con dimmer
    - âœ… Umbrales y delays configurables
    - âœ… Transiciones suaves

    **Funcionamiento:**
    1. Al detectar presencia + condiciÃ³n de oscuridad + dentro del rango â†’ Enciende luces apagadas
    2. Al no detectar presencia por X segundos â†’ Apaga las mismas luces
    3. Solo afecta luces que estaban apagadas inicialmente

    **Ideal para:** Dormitorios, baÃ±os, pasillos, cualquier habitaciÃ³n con SmartNode

  domain: automation
  source_url: https://github.com/mauitz/home-assistant-blueprints/blob/main/blueprints/smartnode_multi_light_presence.yaml

  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SENSORES SMARTNODE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    presence_sensor:
      name: Sensor de Presencia *
      description: Sensor de presencia del SmartNode (binary_sensor)
      selector:
        entity:
          filter:
            - domain: binary_sensor
              device_class: occupancy
          multiple: false

    brightness_sensor:
      name: Sensor de Luminosidad *
      description: Sensor de luminosidad del SmartNode (sensor en %)
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    distance_sensor:
      name: Sensor de Distancia
      description: Sensor de distancia de detecciÃ³n del SmartNode (opcional)
      default: ""
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # LUCES A CONTROLAR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    target_lights:
      name: Luces/Switches *
      description: Luces o switches a controlar (pueden ser mÃºltiples)
      selector:
        entity:
          filter:
            - domain:
              - light
              - switch
          multiple: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIGURACIÃ“N DE ILUMINACIÃ“N
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    brightness_level:
      name: Nivel de Brillo
      description: Porcentaje de brillo al encender (solo para luces con dimmer)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider

    transition_time:
      name: Tiempo de TransiciÃ³n
      description: Tiempo de transiciÃ³n al encender/apagar (segundos)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "s"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONDICIONES Y UMBRALES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    brightness_threshold:
      name: Umbral de Oscuridad
      description: Por debajo de este % de luminosidad se considera oscuro
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider

    only_when_dark:
      name: Solo Cuando EstÃ¡ Oscuro
      description: Si se desactiva, encenderÃ¡ luces sin importar la luminosidad
      default: true
      selector:
        boolean:

    max_detection_distance:
      name: Distancia MÃ¡xima de DetecciÃ³n
      description: Distancia mÃ¡xima en metros para activar luces (0 = sin lÃ­mite)
      default: 0
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "m"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # DELAYS Y TIMING
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    turn_on_delay:
      name: Delay al Encender
      description: Segundos de espera antes de encender (evita falsos positivos)
      default: 0
      selector:
        number:
          min: 0
          max: 30
          unit_of_measurement: "s"
          mode: slider

    turn_off_delay:
      name: Delay al Apagar
      description: Segundos despuÃ©s de no detectar presencia para apagar
      default: 60
      selector:
        number:
          min: 5
          max: 600
          unit_of_measurement: "s"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # OPCIONES AVANZADAS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    enable_logging:
      name: Habilitar Logs
      description: Registrar eventos en el logbook (Ãºtil para debug)
      default: true
      selector:
        boolean:

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
variables:
  presence_entity: !input presence_sensor
  brightness_entity: !input brightness_sensor
  distance_entity: !input distance_sensor
  lights: !input target_lights
  brightness_pct: !input brightness_level
  transition: !input transition_time
  brightness_limit: !input brightness_threshold
  only_dark: !input only_when_dark
  max_distance: !input max_detection_distance
  enable_logs: !input enable_logging
  has_distance_sensor: "{{ distance_entity != '' and distance_entity is not none }}"
  use_distance_limit: "{{ max_distance > 0 and has_distance_sensor }}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MODO DE EJECUCIÃ“N
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mode: restart
max_exceeded: silent

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRIGGERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trigger:
  # TRIGGER 1: Presencia detectada
  - platform: state
    entity_id: !input presence_sensor
    from: "off"
    to: "on"
    for:
      seconds: !input turn_on_delay
    id: presence_detected

  # TRIGGER 2: Presencia perdida
  - platform: state
    entity_id: !input presence_sensor
    from: "on"
    to: "off"
    for:
      seconds: !input turn_off_delay
    id: presence_lost

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACCIONES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
action:
  - choose:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CASO 1: ENCENDER LUCES (PRESENCIA DETECTADA)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: trigger
            id: presence_detected

          # CONDICIÃ“N: Verificar si estÃ¡ oscuro (solo si only_when_dark = true)
          - condition: or
            conditions:
              # OpciÃ³n 1: No importa la luminosidad
              - condition: template
                value_template: "{{ not only_dark }}"

              # OpciÃ³n 2: EstÃ¡ oscuro segÃºn el umbral
              - condition: numeric_state
                entity_id: !input brightness_sensor
                below: !input brightness_threshold

          # CONDICIÃ“N: Verificar distancia de detecciÃ³n (solo si estÃ¡ configurada)
          - condition: or
            conditions:
              # OpciÃ³n 1: No hay lÃ­mite de distancia configurado
              - condition: template
                value_template: "{{ not use_distance_limit }}"

              # OpciÃ³n 2: La distancia estÃ¡ dentro del rango configurado
              - condition: numeric_state
                entity_id: !input distance_sensor
                below: !input max_detection_distance

        sequence:
          # Variables para tracking
          - variables:
              lights_turned_on: []
              current_brightness: "{{ states(brightness_entity) | float(0) }}"
              current_distance: "{{ states(distance_entity) | float(0) if has_distance_sensor else 0 }}"

          # Log de inicio
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_logs }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "ðŸ  SmartNode Multi-Light"
                      message: >
                        Presencia detectada
                        Luminosidad: {{ current_brightness }}%
                        Umbral: {{ brightness_limit }}%
                        {% if has_distance_sensor %}Distancia: {{ current_distance }}m{% if use_distance_limit %} (mÃ¡x: {{ max_distance }}m){% endif %}
                        {% endif %}Luces configuradas: {{ lights | length }}

          # Procesar cada luz
          - repeat:
              for_each: "{{ lights }}"
              sequence:
                - variables:
                    current_light: "{{ repeat.item }}"
                    current_domain: "{{ current_light.split('.')[0] }}"
                    is_off: "{{ is_state(current_light, 'off') }}"

                # Solo encender si estÃ¡ apagada
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ is_off }}"
                      sequence:
                        # Encender luz (con o sin dimmer)
                        - choose:
                            # Si es una luz con soporte de brillo
                            - conditions:
                                - condition: template
                                  value_template: >
                                    {{ current_domain == 'light' and
                                       state_attr(current_light, 'supported_features') is not none and
                                       state_attr(current_light, 'supported_features') | int | bitwise_and(1) == 1 }}
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ current_light }}"
                                  data:
                                    brightness_pct: "{{ brightness_pct }}"
                                    transition: "{{ transition }}"

                          # Si es switch o luz simple
                          default:
                            - service: homeassistant.turn_on
                              target:
                                entity_id: "{{ current_light }}"

                        # Agregar a lista de encendidas
                        - variables:
                            lights_turned_on: "{{ lights_turned_on + [current_light] }}"

                        # Log individual
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ enable_logs }}"
                              sequence:
                                - service: logbook.log
                                  data:
                                    name: "ðŸ’¡ SmartNode Multi-Light"
                                    message: >
                                      Encendida: {{ state_attr(current_light, 'friendly_name') or current_light }}

          # Log final de encendido
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_logs and lights_turned_on | length > 0 }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "âœ… SmartNode Multi-Light"
                      message: >
                        Total encendidas: {{ lights_turned_on | length }} luz(es)

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CASO 2: APAGAR LUCES (SIN PRESENCIA)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: trigger
            id: presence_lost

        sequence:
          # Variables para tracking
          - variables:
              lights_turned_off: []

          # Log de inicio
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_logs }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "ðŸŒ™ SmartNode Multi-Light"
                      message: >
                        Ausencia detectada ({{ turn_off_delay }}s)
                        Verificando luces a apagar...

          # Procesar cada luz
          - repeat:
              for_each: "{{ lights }}"
              sequence:
                - variables:
                    current_light: "{{ repeat.item }}"
                    current_domain: "{{ current_light.split('.')[0] }}"
                    is_on: "{{ is_state(current_light, 'on') }}"

                # Solo apagar si estÃ¡ encendida
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ is_on }}"
                      sequence:
                        # Apagar luz (con o sin transiciÃ³n)
                        - choose:
                            # Si es una luz
                            - conditions:
                                - condition: template
                                  value_template: "{{ current_domain == 'light' }}"
                              sequence:
                                - service: light.turn_off
                                  target:
                                    entity_id: "{{ current_light }}"
                                  data:
                                    transition: "{{ transition }}"

                          # Si es switch
                          default:
                            - service: homeassistant.turn_off
                              target:
                                entity_id: "{{ current_light }}"

                        # Agregar a lista de apagadas
                        - variables:
                            lights_turned_off: "{{ lights_turned_off + [current_light] }}"

                        # Log individual
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ enable_logs }}"
                              sequence:
                                - service: logbook.log
                                  data:
                                    name: "ðŸ”Œ SmartNode Multi-Light"
                                    message: >
                                      Apagada: {{ state_attr(current_light, 'friendly_name') or current_light }}

          # Log final de apagado
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_logs and lights_turned_off | length > 0 }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "âœ… SmartNode Multi-Light"
                      message: >
                        Total apagadas: {{ lights_turned_off | length }} luz(es)

