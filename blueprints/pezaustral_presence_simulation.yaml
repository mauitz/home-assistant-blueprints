blueprint:
  name: PezAustral Presence Simulation v1.3
  description: >
    # üè† PezAustral Presence Simulation **Version: 1.3**
    
    **NUEVO EN ESTA VERSI√ìN:**
    - ‚úÖ **MONITOREO INTEGRADO** - Actualiza contadores autom√°ticamente
    - ‚úÖ No requiere automatizaciones externas de monitoreo
    - ‚úÖ Actualiza lista de luces activas en tiempo real
    - ‚úÖ Tracking de √∫ltima luz encendida/apagada
    - ‚úÖ Contador de luces simult√°neas
    
    **VERSI√ìN 1.2:**
    - ‚úÖ LOGGING DETALLADO en el Logbook de Home Assistant
    - ‚úÖ Tracking de cada luz que se enciende/apaga
    - ‚úÖ Registro de inicio/fin de cada loop
    - ‚úÖ Informaci√≥n de configuraci√≥n al iniciar
    
    **VERSI√ìN 1.1:**
    - ‚úÖ SE PUEDE DETENER desactivando el input_boolean
    - ‚úÖ Verifica el estado ANTES de cada acci√≥n
    - ‚úÖ Se detiene inmediatamente al desactivar
    - ‚úÖ Modo `single` para evitar m√∫ltiples ejecuciones
    
    Simulaci√≥n avanzada de presencia con control de l√°mparas simult√°neas, loops y escena de salida.
    
    **Basado en:** [Holiday & Away Lighting by Blackshome](https://gist.github.com/Blackshome/0a34870755762bcb9fab159d5b94fd25)
    
    Documentaci√≥n completa: Ver docs/pezaustral_presence_simulation/
    
    Required = *
    
  domain: automation
  source_url: https://github.com/mauitz/home-assistant-blueprints/blob/main/blueprints/pezaustral_presence_simulation.yaml
  
  input:
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # MONITOREO (NUEVO EN V1.3)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    monitoring_config:
      name: "‚öôÔ∏è Configuraci√≥n de Monitoreo"
      icon: mdi:monitor-dashboard
      collapsed: true
      input:
        enable_monitoring:
          name: Habilitar Monitoreo Integrado
          description: >
            Actualiza autom√°ticamente los helpers de monitoreo (input_boolean.presence_simulation_running,
            input_number.presence_simulation_lights_on_count, input_text.presence_simulation_active_lights, etc.).
            Si no tienes estos helpers, d√©jalo deshabilitado.
          default: true
          selector:
            boolean:
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # CONTROL DE AUTOMATIZACI√ìN (del v1.2)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    automation_control:
      name: "Control de Automatizaci√≥n"
      icon: mdi:auto-mode
      collapsed: true
      input:
        automation_control_entity:
          name: Entidad de Control (Opcional)
          description: >
            Selecciona una entidad (input_boolean, switch, etc.) para activar/desactivar la automatizaci√≥n.
            **IMPORTANTE**: La automatizaci√≥n verificar√° este estado constantemente y se detendr√° si se desactiva.
          default: []
          selector:
            entity:
              multiple: false
        
        start_date:
          name: Fecha de Inicio (Opcional)
          description: Fecha desde la cual la automatizaci√≥n estar√° activa
          default: ""
          selector:
            date:
        
        end_date:
          name: Fecha de Fin (Opcional)
          description: Fecha hasta la cual la automatizaci√≥n estar√° activa
          default: ""
          selector:
            date:
        
        zone_control:
          name: Zona de Control (Opcional)
          description: Solo ejecutar cuando estas personas NO est√©n en esta zona
          default: []
          selector:
            entity:
              domain: zone
              multiple: false
        
        people_control:
          name: Personas (Opcional)
          description: Personas a monitorear para la zona de control
          default: []
          selector:
            entity:
              domain:
                - person
                - device_tracker
              multiple: true
        
        weekdays:
          name: D√≠as de la Semana
          description: Selecciona en qu√© d√≠as ejecutar la automatizaci√≥n
          default: ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']
          selector:
            select:
              options:
                - label: "Lunes"
                  value: "mon"
                - label: "Martes"
                  value: "tue"
                - label: "Mi√©rcoles"
                  value: "wed"
                - label: "Jueves"
                  value: "thu"
                - label: "Viernes"
                  value: "fri"
                - label: "S√°bado"
                  value: "sat"
                - label: "Domingo"
                  value: "sun"
              multiple: true
              custom_value: false
        
        global_conditions:
          name: Condiciones Globales (Opcional)
          description: Condiciones adicionales que deben cumplirse
          default: []
          selector:
            condition:

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # TRIGGERS
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    trigger_config:
      name: "üéØ Configuraci√≥n de Disparadores"
      icon: mdi:bell-ring
      collapsed: true
      input:
        trigger_type:
          name: Tipo de Disparador *
          description: C√≥mo se iniciar√° la automatizaci√≥n
          default: entity_on
          selector:
            select:
              options:
                - label: "Entidad cambia a ON"
                  value: "entity_on"
                - label: "Entidad cambia a OFF"
                  value: "entity_off"
                - label: "Hora espec√≠fica"
                  value: "time"
                - label: "Elevaci√≥n del sol"
                  value: "sun_elevation"
                - label: "Luz ambiental"
                  value: "ambient_light"
              custom_value: false
        
        trigger_entity:
          name: Entidad Disparadora (para entity_on/off)
          description: Entidad que disparar√° la automatizaci√≥n
          default: []
          selector:
            entity:
              multiple: false
        
        trigger_time:
          name: Hora de Disparo (para time)
          description: Hora espec√≠fica para iniciar
          default: "20:00:00"
          selector:
            time:
        
        sun_elevation:
          name: Elevaci√≥n del Sol (para sun_elevation)
          description: Grados sobre el horizonte (-90 a 90)
          default: -3
          selector:
            number:
              min: -90
              max: 90
              unit_of_measurement: "¬∞"
        
        ambient_light_entity:
          name: Sensor de Luz Ambiental (para ambient_light)
          description: Sensor que mide la luz ambiental
          default: []
          selector:
            entity:
              domain: sensor
              device_class: illuminance
        
        ambient_light_threshold:
          name: Umbral de Luz Ambiental (lux)
          description: Valor por debajo del cual se dispara
          default: 100
          selector:
            number:
              min: 0
              max: 10000
              unit_of_measurement: "lux"

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # LIGHTS/SWITCHES
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    lights_config:
      name: "üí° Configuraci√≥n de Luces"
      icon: mdi:lightbulb-group
      collapsed: false
      input:
        lights_on:
          name: Luces/Switches a Encender *
          description: Selecciona las entidades que se encender√°n
          selector:
            entity:
              domain:
                - light
                - switch
              multiple: true
        
        max_lights_on:
          name: M√°ximo de Luces Simult√°neas *
          description: >
            **NUEVA CARACTER√çSTICA**: M√°ximo n√∫mero de luces encendidas al mismo tiempo.
            Cuando se alcance este l√≠mite, se apagar√° la luz m√°s antigua antes de encender una nueva.
          default: 2
          selector:
            number:
              min: 1
              max: 20
              mode: box
        
        entity_order_on:
          name: Orden de Encendido
          description: C√≥mo se seleccionar√° el orden para encender las luces
          default: entities_on_shuffled
          selector:
            select:
              options:
                - label: "Aleatorio (Shuffled)"
                  value: "entities_on_shuffled"
                - label: "Secuencial"
                  value: "entities_on_sequence"
                - label: "Reverso"
                  value: "entities_on_reverse"
                - label: "Todas al mismo tiempo"
                  value: "entities_on_same_time"
              custom_value: false
        
        random_on_delay_min:
          name: Delay M√≠nimo de Encendido (segundos)
          description: Tiempo m√≠nimo de espera antes de encender la siguiente luz
          default: 10
          selector:
            number:
              min: 0
              max: 3600
              unit_of_measurement: "s"
              mode: box
        
        random_on_delay_max:
          name: Delay M√°ximo de Encendido (segundos)
          description: Tiempo m√°ximo de espera antes de encender la siguiente luz
          default: 300
          selector:
            number:
              min: 0
              max: 3600
              unit_of_measurement: "s"
              mode: box
        
        brightness:
          name: Brillo (solo para luces)
          description: Nivel de brillo (0-100%)
          default: 100
          selector:
            number:
              min: 0
              max: 100
              unit_of_measurement: "%"
        
        color_temp:
          name: Temperatura de Color (solo para luces)
          description: En mireds (153-500)
          default: 3000
          selector:
            number:
              min: 153
              max: 500
        
        transition_on:
          name: Transici√≥n de Encendido (segundos)
          description: Duraci√≥n de la transici√≥n al encender
          default: 1
          selector:
            number:
              min: 0
              max: 60
              unit_of_measurement: "s"
        
        transition_off:
          name: Transici√≥n de Apagado (segundos)
          description: Duraci√≥n de la transici√≥n al apagar
          default: 1
          selector:
            number:
              min: 0
              max: 60
              unit_of_measurement: "s"

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # DURACI√ìN
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    duration_config:
      name: "‚è±Ô∏è Configuraci√≥n de Duraci√≥n"
      icon: mdi:timer
      collapsed: true
      input:
        duration_method:
          name: M√©todo de Duraci√≥n
          description: C√≥mo determinar cu√°nto tiempo permanecer√°n encendidas las luces
          default: min_max_time
          selector:
            select:
              options:
                - label: "Tiempo Min/Max Aleatorio"
                  value: "min_max_time"
                - label: "Hasta Elevaci√≥n del Sol"
                  value: "sun_elevation"
                - label: "Hasta Umbral de Luz Ambiental"
                  value: "ambient_light"
              custom_value: false
        
        min_on_time:
          name: Tiempo M√≠nimo Encendido (minutos) *
          description: M√≠nimo de minutos que cada luz permanecer√° encendida
          default: 8
          selector:
            number:
              min: 1
              max: 1440
              unit_of_measurement: "min"
              mode: box
        
        max_on_time:
          name: Tiempo M√°ximo Encendido (minutos) *
          description: M√°ximo de minutos que cada luz permanecer√° encendida
          default: 30
          selector:
            number:
              min: 1
              max: 1440
              unit_of_measurement: "min"
              mode: box

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # LOOPS (NUEVA CARACTER√çSTICA)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    loop_config:
      name: "üîÑ Configuraci√≥n de Loops"
      icon: mdi:repeat
      collapsed: true
      input:
        enable_loop:
          name: Habilitar Loop
          description: >
            **NUEVA CARACTER√çSTICA**: Permite que la automatizaci√≥n se repita m√∫ltiples veces.
            √ötil para simular presencia durante toda la noche.
          default: false
          selector:
            boolean:
        
        loop_count:
          name: Cantidad de Loops
          description: >
            N√∫mero de veces que se ejecutar√° la secuencia completa.
            Deja en 0 para loop infinito (se detendr√° solo al desactivar el control entity).
          default: 3
          selector:
            number:
              min: 0
              max: 100
              mode: box
        
        loop_delay_min:
          name: Delay M√≠nimo Entre Loops (minutos)
          description: Tiempo m√≠nimo de espera entre cada repetici√≥n
          default: 5
          selector:
            number:
              min: 0
              max: 1440
              unit_of_measurement: "min"
              mode: box
        
        loop_delay_max:
          name: Delay M√°ximo Entre Loops (minutos)
          description: Tiempo m√°ximo de espera entre cada repetici√≥n
          default: 15
          selector:
            number:
              min: 0
              max: 1440
              unit_of_measurement: "min"
              mode: box

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # ESCENAS DE SALIDA (NUEVA CARACTER√çSTICA)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    exit_config:
      name: "üé¨ Escenas de Salida"
      icon: mdi:exit-run
      collapsed: true
      input:
        enable_exit_scene:
          name: Habilitar Escena de Salida
          description: >
            **NUEVA CARACTER√çSTICA**: Activa una escena al finalizar todos los loops.
            √ötil para apagar todas las luces o configurar un estado espec√≠fico.
          default: false
          selector:
            boolean:
        
        exit_scene:
          name: Escena de Salida Normal
          description: Escena a activar cuando la automatizaci√≥n termina normalmente
          default: []
          selector:
            entity:
              domain: scene
              multiple: false
        
        emergency_stop_scene:
          name: Escena de Parada de Emergencia
          description: Escena a activar cuando la automatizaci√≥n se detiene manualmente
          default: []
          selector:
            entity:
              domain: scene
              multiple: false

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# VARIABLES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
variables:
  # Monitoring
  enable_monitoring: !input enable_monitoring
  
  # Control
  automation_control_entity: !input automation_control_entity
  start_date: !input start_date
  end_date: !input end_date
  zone_control: !input zone_control
  people_control: !input people_control
  weekdays: !input weekdays
  global_conditions: !input global_conditions
  
  # Triggers
  trigger_type: !input trigger_type
  trigger_entity: !input trigger_entity
  trigger_time: !input trigger_time
  sun_elevation: !input sun_elevation
  ambient_light_entity: !input ambient_light_entity
  ambient_light_threshold: !input ambient_light_threshold
  
  # Lights
  lights_on: !input lights_on
  max_lights_on: !input max_lights_on
  entity_order_on: !input entity_order_on
  random_on_delay_min: !input random_on_delay_min
  random_on_delay_max: !input random_on_delay_max
  brightness: !input brightness
  color_temp: !input color_temp
  transition_on: !input transition_on
  transition_off: !input transition_off
  
  # Duration
  duration_method: !input duration_method
  min_on_time: !input min_on_time
  max_on_time: !input max_on_time
  
  # Loop
  enable_loop: !input enable_loop
  loop_count: !input loop_count
  loop_delay_min: !input loop_delay_min
  loop_delay_max: !input loop_delay_max
  
  # Exit
  enable_exit_scene: !input enable_exit_scene
  exit_scene: !input exit_scene
  emergency_stop_scene: !input emergency_stop_scene
  
  # Derived variables
  entities_turn_on: >-
    {% set lights_list = lights_on %}
    {% set ns = namespace(result=[]) %}
    {% for light in lights_list %}
      {% set entity_id = light %}
      {% set domain = entity_id.split('.')[0] %}
      {% if domain == 'light' %}
        {% set data = {
          'brightness_pct': brightness,
          'color_temp': color_temp,
          'transition': transition_on
        } %}
      {% else %}
        {% set data = {} %}
      {% endif %}
      {% set ns.result = ns.result + [{'id': entity_id, 'data': data}] %}
    {% endfor %}
    {{ ns.result }}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TRIGGERS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
trigger:
  - platform: state
    id: trigger_entity_on
    entity_id: !input trigger_entity
    to: "on"
  
  - platform: state
    id: trigger_entity_off
    entity_id: !input trigger_entity
    to: "off"
  
  - platform: time
    id: trigger_time
    at: !input trigger_time
  
  - platform: numeric_state
    id: trigger_sun
    entity_id: sun.sun
    attribute: elevation
    below: !input sun_elevation
  
  - platform: numeric_state
    id: trigger_ambient
    entity_id: !input ambient_light_entity
    below: !input ambient_light_threshold

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# CONDITIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
condition:
  - alias: "Validar trigger correcto"
    condition: or
    conditions:
      - condition: template
        value_template: >-
          {% if trigger_type == 'time' %}
            {{ trigger.id == 'trigger_time' }}
          {% elif trigger_type == 'sun_elevation' %}
            {{ trigger.id == 'trigger_sun' }}
          {% elif trigger_type == 'ambient_light' %}
            {{ trigger.id == 'trigger_ambient' }}
          {% elif trigger_type == 'entity_on' %}
            {{ trigger.id == 'trigger_entity_on' }}
          {% elif trigger_type == 'entity_off' %}
            {{ trigger.id == 'trigger_entity_off' }}
          {% else %}
            false
          {% endif %}
  
  - alias: "Validar d√≠a de la semana"
    condition: template
    value_template: >-
      {{ now().strftime('%a').lower() in weekdays }}
  
  - alias: "Validar fechas"
    condition: template
    value_template: >-
      {% set today = now().date() %}
      {% set start = start_date if start_date else none %}
      {% set end = end_date if end_date else none %}
      {% if start and end %}
        {{ today >= start and today <= end }}
      {% elif start %}
        {{ today >= start }}
      {% elif end %}
        {{ today <= end }}
      {% else %}
        true
      {% endif %}
  
  - alias: "Validar zona y personas"
    condition: template
    value_template: >-
      {% if zone_control | length > 0 and people_control | length > 0 %}
        {% set ns = namespace(all_away=true) %}
        {% for person in people_control %}
          {% if is_state(person, zone_control[0].split('.')[1]) %}
            {% set ns.all_away = false %}
          {% endif %}
        {% endfor %}
        {{ ns.all_away }}
      {% else %}
        true
      {% endif %}
  
  - alias: "Validar control entity"
    condition: template
    value_template: >-
      {% if automation_control_entity | length > 0 %}
        {{ is_state(automation_control_entity[0], 'on') }}
      {% else %}
        true
      {% endif %}
  
  - alias: "Condiciones globales"
    condition: !input global_conditions

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ACTION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
mode: single

action:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # INICIALIZACI√ìN + MONITOREO
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  # Actualizar helpers de monitoreo al inicio
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_monitoring }}"
        sequence:
          # Marcar simulaci√≥n como activa
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_boolean.presence_simulation_running') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: input_boolean.presence_simulation_running
          
          # Guardar hora de inicio
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_datetime.presence_simulation_start_time') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: input_datetime.presence_simulation_start_time
                    data:
                      datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
          
          # Guardar total de loops
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_number.presence_simulation_loop_total') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_number.set_value
                    target:
                      entity_id: input_number.presence_simulation_loop_total
                    data:
                      value: "{{ loop_count }}"
          
          # Resetear contador de loops
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_number.presence_simulation_loop_counter') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_number.set_value
                    target:
                      entity_id: input_number.presence_simulation_loop_counter
                    data:
                      value: 0
          
          # Estado inicial
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_text.presence_simulation_status') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: input_text.presence_simulation_status
                    data:
                      value: "Iniciando"
  
  # LOG: Inicio de automatizaci√≥n
  - alias: "Log - Inicio de automatizaci√≥n"
    service: logbook.log
    data:
      name: "PezAustral Presence Simulation"
      message: "üöÄ Iniciando simulaci√≥n - {{ lights_on | length }} luces configuradas, m√°ximo {{ max_lights_on }} simult√°neas"
      entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
  
  # LOG: Configuraci√≥n
  - alias: "Log - Configuraci√≥n"
    service: logbook.log
    data:
      name: "PezAustral Presence Simulation"
      message: >-
        üìã Config: 
        Control={{ automation_control_entity[0] if automation_control_entity | length > 0 else 'Ninguno' }} 
        (Estado={{ states(automation_control_entity[0]) if automation_control_entity | length > 0 else 'N/A' }}), 
        Loop={{ 'S√≠' if enable_loop else 'No' }}, 
        Loops={{ loop_count if loop_count > 0 else 'Infinito' }}, 
        Monitoreo={{ 'S√≠' if enable_monitoring else 'No' }}
      entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
  
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # LOOP PRINCIPAL
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  - repeat:
      while:
        - condition: template
          value_template: >-
            {% if enable_loop %}
              {% if loop_count > 0 %}
                {{ repeat.index <= loop_count }}
              {% else %}
                true
              {% endif %}
            {% else %}
              {{ repeat.index == 1 }}
            {% endif %}
        - condition: template
          value_template: >-
            {% if automation_control_entity | length > 0 %}
              {{ is_state(automation_control_entity[0], 'on') }}
            {% else %}
              true
            {% endif %}
      sequence:
        # LOG: Inicio de loop
        - alias: "Log - Inicio de loop"
          service: logbook.log
          data:
            name: "PezAustral Presence Simulation"
            message: "üîÑ Iniciando Loop {{ repeat.index }}"
            entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
        
        # Actualizar contador de loops en helper (si existe)
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ enable_monitoring }}"
                - condition: template
                  value_template: "{{ states('input_number.presence_simulation_loop_counter') not in ['unknown', 'unavailable'] }}"
              sequence:
                - service: input_number.set_value
                  target:
                    entity_id: input_number.presence_simulation_loop_counter
                  data:
                    value: "{{ repeat.index }}"
                - service: input_text.set_value
                  target:
                    entity_id: input_text.presence_simulation_status
                  data:
                    value: "En ejecuci√≥n - Loop {{ repeat.index }}"
        
        # Variables para tracking de luces encendidas
        - variables:
            lights_currently_on: []
            lights_order: >-
              {% if entity_order_on == 'entities_on_sequence' %}
                {{ entities_turn_on }}
              {% elif entity_order_on == 'entities_on_reverse' %}
                {{ entities_turn_on | reverse | list }}
              {% elif entity_order_on == 'entities_on_shuffled' %}
                {{ entities_turn_on | shuffle }}
              {% else %}
                {{ entities_turn_on }}
              {% endif %}
            loop_interrupted: false
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # SECUENCIA PRINCIPAL DE ENCENDIDO CON CONTROL DE L√çMITE
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        - repeat:
            count: "{{ lights_on | length }}"
            sequence:
              # VERIFICACI√ìN ANTES DE CADA LUZ: ¬øSigue activo el control?
              - condition: template
                value_template: >-
                  {% if automation_control_entity | length > 0 %}
                    {{ is_state(automation_control_entity[0], 'on') }}
                  {% else %}
                    true
                  {% endif %}
              
              - variables:
                  current_light: "{{ lights_order[repeat.index - 1] }}"
                  current_entity_id: "{{ current_light.id }}"
                  current_domain: "{{ current_light.id.split('.')[0] }}"
                  needs_turn_off: >-
                    {{ lights_currently_on | length >= max_lights_on }}
                  light_to_turn_off: >-
                    {% if lights_currently_on | length >= max_lights_on %}
                      {{ lights_currently_on[0] }}
                    {% else %}
                      null
                    {% endif %}
              
              # Si alcanzamos el l√≠mite, apagar la luz m√°s antigua
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ needs_turn_off and light_to_turn_off != 'null' }}"
                    sequence:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ light_to_turn_off.split('.')[0] == 'light' }}"
                            sequence:
                              - action: light.turn_off
                                target:
                                  entity_id: "{{ light_to_turn_off }}"
                                data:
                                  transition: "{{ transition_off }}"
                        default:
                          - action: homeassistant.turn_off
                            target:
                              entity_id: "{{ light_to_turn_off }}"
                      
                      # LOG: Luz apagada por l√≠mite
                      - alias: "Log - Luz apagada por l√≠mite"
                        service: logbook.log
                        data:
                          name: "PezAustral Presence Simulation"
                          message: "üåë Apagada (l√≠mite): {{ state_attr(light_to_turn_off, 'friendly_name') or light_to_turn_off }}"
                          entity_id: "{{ light_to_turn_off }}"
                      
                      # MONITOREO: Actualizar √∫ltima luz apagada
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ enable_monitoring }}"
                              - condition: template
                                value_template: "{{ states('input_text.presence_simulation_last_light_off') not in ['unknown', 'unavailable'] }}"
                            sequence:
                              - service: input_text.set_value
                                target:
                                  entity_id: input_text.presence_simulation_last_light_off
                                data:
                                  value: "{{ state_attr(light_to_turn_off, 'friendly_name') or light_to_turn_off }}"
                      
                      - variables:
                          lights_currently_on: >-
                            {{ lights_currently_on[1:] }}
              
              # Delay aleatorio antes de encender (si no es "todas al mismo tiempo")
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ entity_order_on != 'entities_on_same_time' and repeat.index > 1 }}"
                    sequence:
                      - delay:
                          seconds: >-
                            {{ range(random_on_delay_min, random_on_delay_max + 1) | random }}
              
              # VERIFICACI√ìN ANTES DE ENCENDER
              - condition: template
                value_template: >-
                  {% if automation_control_entity | length > 0 %}
                    {{ is_state(automation_control_entity[0], 'on') }}
                  {% else %}
                    true
                  {% endif %}
              
              # Encender la luz actual
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ current_domain == 'light' }}"
                    sequence:
                      - action: light.turn_on
                        target:
                          entity_id: "{{ current_entity_id }}"
                        data: >-
                          {{ current_light.data }}
                default:
                  - action: homeassistant.turn_on
                    target:
                      entity_id: "{{ current_entity_id }}"
              
              # LOG: Luz encendida
              - alias: "Log - Luz encendida"
                service: logbook.log
                data:
                  name: "PezAustral Presence Simulation"
                  message: "üí° Encendida: {{ state_attr(current_entity_id, 'friendly_name') or current_entity_id }}"
                  entity_id: "{{ current_entity_id }}"
              
              # MONITOREO: Actualizar √∫ltima luz encendida
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ enable_monitoring }}"
                      - condition: template
                        value_template: "{{ states('input_text.presence_simulation_last_light_on') not in ['unknown', 'unavailable'] }}"
                    sequence:
                      - service: input_text.set_value
                        target:
                          entity_id: input_text.presence_simulation_last_light_on
                        data:
                          value: "{{ state_attr(current_entity_id, 'friendly_name') or current_entity_id }}"
              
              # Agregar a lista de luces encendidas
              - variables:
                  lights_currently_on: >-
                    {{ lights_currently_on + [current_entity_id] }}
              
              # MONITOREO: Actualizar contador y lista de luces activas
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ enable_monitoring }}"
                    sequence:
                      # Actualizar contador
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ states('input_number.presence_simulation_lights_on_count') not in ['unknown', 'unavailable'] }}"
                            sequence:
                              - service: input_number.set_value
                                target:
                                  entity_id: input_number.presence_simulation_lights_on_count
                                data:
                                  value: "{{ lights_currently_on | length }}"
                      
                      # Actualizar lista de nombres
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ states('input_text.presence_simulation_active_lights') not in ['unknown', 'unavailable'] }}"
                            sequence:
                              - service: input_text.set_value
                                target:
                                  entity_id: input_text.presence_simulation_active_lights
                                data:
                                  value: >-
                                    {% set ns = namespace(names=[]) %}
                                    {% for light in lights_currently_on %}
                                      {% set name = state_attr(light, 'friendly_name') or light %}
                                      {% set ns.names = ns.names + [name] %}
                                    {% endfor %}
                                    {{ ns.names | join(', ') if ns.names | length > 0 else 'Ninguna' }}
              
              # Esperar tiempo aleatorio antes de apagar esta luz
              - wait_template: >-
                  {% if automation_control_entity | length > 0 %}
                    {{ is_state(automation_control_entity[0], 'off') }}
                  {% else %}
                    false
                  {% endif %}
                timeout:
                  minutes: >-
                    {% if duration_method == 'min_max_time' %}
                      {{ range(min_on_time, max_on_time + 1) | random }}
                    {% else %}
                      {{ range(min_on_time, max_on_time + 1) | random }}
                    {% endif %}
                continue_on_timeout: true
              
              # Si se detuvo (wait_template se cumpli√≥), salir
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {% if automation_control_entity | length > 0 %}
                            {{ is_state(automation_control_entity[0], 'off') }}
                          {% else %}
                            false
                          {% endif %}
                    sequence:
                      - variables:
                          loop_interrupted: true
                      - stop: "Automatizaci√≥n detenida por el usuario"
              
              # Apagar esta luz despu√©s del delay
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ current_domain == 'light' }}"
                    sequence:
                      - action: light.turn_off
                        target:
                          entity_id: "{{ current_entity_id }}"
                        data:
                          transition: "{{ transition_off }}"
                default:
                  - action: homeassistant.turn_off
                    target:
                      entity_id: "{{ current_entity_id }}"
              
              # LOG: Luz apagada
              - alias: "Log - Luz apagada"
                service: logbook.log
                data:
                  name: "PezAustral Presence Simulation"
                  message: "üåë Apagada: {{ state_attr(current_entity_id, 'friendly_name') or current_entity_id }}"
                  entity_id: "{{ current_entity_id }}"
              
              # MONITOREO: Actualizar √∫ltima luz apagada
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ enable_monitoring }}"
                      - condition: template
                        value_template: "{{ states('input_text.presence_simulation_last_light_off') not in ['unknown', 'unavailable'] }}"
                    sequence:
                      - service: input_text.set_value
                        target:
                          entity_id: input_text.presence_simulation_last_light_off
                        data:
                          value: "{{ state_attr(current_entity_id, 'friendly_name') or current_entity_id }}"
              
              # Remover de lista de luces encendidas
              - variables:
                  lights_currently_on: >-
                    {{ lights_currently_on | reject('eq', current_entity_id) | list }}
              
              # MONITOREO: Actualizar contador y lista despu√©s de apagar
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ enable_monitoring }}"
                    sequence:
                      # Actualizar contador
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ states('input_number.presence_simulation_lights_on_count') not in ['unknown', 'unavailable'] }}"
                            sequence:
                              - service: input_number.set_value
                                target:
                                  entity_id: input_number.presence_simulation_lights_on_count
                                data:
                                  value: "{{ lights_currently_on | length }}"
                      
                      # Actualizar lista
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ states('input_text.presence_simulation_active_lights') not in ['unknown', 'unavailable'] }}"
                            sequence:
                              - service: input_text.set_value
                                target:
                                  entity_id: input_text.presence_simulation_active_lights
                                data:
                                  value: >-
                                    {% set ns = namespace(names=[]) %}
                                    {% for light in lights_currently_on %}
                                      {% set name = state_attr(light, 'friendly_name') or light %}
                                      {% set ns.names = ns.names + [name] %}
                                    {% endfor %}
                                    {{ ns.names | join(', ') if ns.names | length > 0 else 'Ninguna' }}
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # CLEANUP: Apagar cualquier luz que a√∫n est√© encendida
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        - repeat:
            count: "{{ lights_currently_on | length }}"
            sequence:
              - variables:
                  light_to_cleanup: "{{ lights_currently_on[repeat.index - 1] }}"
                  cleanup_domain: "{{ light_to_cleanup.split('.')[0] }}"
              
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ cleanup_domain == 'light' }}"
                    sequence:
                      - action: light.turn_off
                        target:
                          entity_id: "{{ light_to_cleanup }}"
                        data:
                          transition: "{{ transition_off }}"
                default:
                  - action: homeassistant.turn_off
                    target:
                      entity_id: "{{ light_to_cleanup }}"
              
              # LOG: Luz apagada en cleanup
              - alias: "Log - Luz apagada (cleanup)"
                service: logbook.log
                data:
                  name: "PezAustral Presence Simulation"
                  message: "üßπ Apagada (cleanup): {{ state_attr(light_to_cleanup, 'friendly_name') or light_to_cleanup }}"
                  entity_id: "{{ light_to_cleanup }}"
        
        # MONITOREO: Resetear contadores despu√©s del cleanup
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ enable_monitoring }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ states('input_number.presence_simulation_lights_on_count') not in ['unknown', 'unavailable'] }}"
                      sequence:
                        - service: input_number.set_value
                          target:
                            entity_id: input_number.presence_simulation_lights_on_count
                          data:
                            value: 0
                
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ states('input_text.presence_simulation_active_lights') not in ['unknown', 'unavailable'] }}"
                      sequence:
                        - service: input_text.set_value
                          target:
                            entity_id: input_text.presence_simulation_active_lights
                          data:
                            value: "Ninguna"
        
        # LOG: Loop completado
        - alias: "Log - Loop completado"
          service: logbook.log
          data:
            name: "PezAustral Presence Simulation"
            message: "‚úÖ Loop {{ repeat.index }} completado"
            entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
        
        # Delay entre loops (si est√° habilitado el loop y sigue activo)
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ enable_loop and not loop_interrupted }}
                - condition: template
                  value_template: >-
                    {% if automation_control_entity | length > 0 %}
                      {{ is_state(automation_control_entity[0], 'on') }}
                    {% else %}
                      true
                    {% endif %}
              sequence:
                - alias: "Log - Delay entre loops"
                  service: logbook.log
                  data:
                    name: "PezAustral Presence Simulation"
                    message: "‚è∏Ô∏è Esperando {{ range(loop_delay_min, loop_delay_max + 1) | random }} minutos antes del siguiente loop"
                    entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
                - delay:
                    minutes: >-
                      {{ range(loop_delay_min, loop_delay_max + 1) | random }}
  
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # FINALIZACI√ìN
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  # LOG: Automatizaci√≥n finalizada
  - alias: "Log - Automatizaci√≥n finalizada"
    service: logbook.log
    data:
      name: "PezAustral Presence Simulation"
      message: "üèÅ Simulaci√≥n finalizada - Todos los loops completados"
      entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
  
  # MONITOREO: Marcar como inactiva
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_monitoring }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_boolean.presence_simulation_running') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.presence_simulation_running
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ states('input_text.presence_simulation_status') not in ['unknown', 'unavailable'] }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: input_text.presence_simulation_status
                    data:
                      value: "Finalizada"
  
  # Escena de salida (si est√° habilitada)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_exit_scene and exit_scene | length > 0 }}"
        sequence:
          - alias: "Log - Activando escena de salida"
            service: logbook.log
            data:
              name: "PezAustral Presence Simulation"
              message: "üé¨ Activando escena de salida: {{ exit_scene[0] }}"
              entity_id: "{{ automation_control_entity[0] if automation_control_entity | length > 0 else '' }}"
          
          - action: scene.turn_on
            target:
              entity_id: "{{ exit_scene[0] }}"

