blueprint:
  name: PezAustral Presence Simulation v2.1
  description: >
    # ğŸ  SimulaciÃ³n de Presencia Inteligente

    **VERSIÃ“N 2.1 - BUG CRÃTICO CORREGIDO**

    âœ… **FIX v2.1** - Ahora mantiene mÃºltiples luces encendidas simultÃ¡neamente (bug crÃ­tico v2.0 corregido)
    âœ… **CLEANUP AUTOMÃTICO** - Apaga TODAS las luces al detener (sin automatizaciones extras)
    âœ… **MONITOREO INTEGRADO** - Actualiza contadores automÃ¡ticamente
    âœ… **DETENCIÃ“N LIMPIA** - Se puede detener en cualquier momento
    âœ… **ESCENAS DE SALIDA** - Configurables para fin normal o emergencia
    âœ… **CONTROL DE LÃMPARAS** - MÃ¡ximo simultÃ¡neas configurable (Â¡AHORA FUNCIONA!)
    âœ… **LOGS DETALLADOS** - Tracking completo en Logbook

    **CAMBIOS v2.1:**
    - FIX CRÃTICO: Las luces ahora permanecen encendidas simultÃ¡neamente
    - RotaciÃ³n real de luces segÃºn max_lights_on
    - Delay corto entre encendidos (no apaga inmediatamente)
    - Las luces se mantienen encendidas durante todo el loop

    **DocumentaciÃ³n:** https://github.com/mauitz/home-assistant-blueprints

  domain: automation
  source_url: https://github.com/mauitz/home-assistant-blueprints/blob/main/blueprints/pezaustral_presence_simulation.yaml

  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONTROL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    automation_control_entity:
      name: Entidad de Control *
      description: Input boolean para activar/desactivar la simulaciÃ³n
      selector:
        entity:
          domain: input_boolean

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # LUCES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    lights:
      name: Luces/Switches *
      description: Dispositivos que se encenderÃ¡n/apagarÃ¡n
      selector:
        entity:
          domain: [light, switch]
          multiple: true

    max_lights_on:
      name: MÃ¡ximo SimultÃ¡neas
      description: MÃ¡ximo de luces encendidas al mismo tiempo
      default: 2
      selector:
        number:
          min: 1
          max: 20
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # TIMING
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    loop_count:
      name: Loops
      description: NÃºmero de repeticiones (99 = infinito)
      default: 10
      selector:
        number:
          min: 0
          max: 99
          mode: box

    time_on_min:
      name: Tiempo Encendido MÃ­nimo (min)
      description: Cada luz permanecerÃ¡ encendida al menos este tiempo
      default: 15
      selector:
        number:
          min: 1
          max: 240
          mode: box

    time_on_max:
      name: Tiempo Encendido MÃ¡ximo (min)
      description: Cada luz permanecerÃ¡ encendida como mÃ¡ximo este tiempo
      default: 45
      selector:
        number:
          min: 1
          max: 240
          mode: box

    delay_between_lights_min:
      name: Delay Entre Luces MÃ­nimo (seg)
      description: Tiempo mÃ­nimo de espera antes de encender la siguiente luz
      default: 10
      selector:
        number:
          min: 1
          max: 300
          mode: box

    delay_between_lights_max:
      name: Delay Entre Luces MÃ¡ximo (seg)
      description: Tiempo mÃ¡ximo de espera antes de encender la siguiente luz
      default: 60
      selector:
        number:
          min: 1
          max: 300
          mode: box

    loop_delay_min:
      name: Delay Entre Loops MÃ­nimo (min)
      description: Pausa entre repeticiones completas
      default: 5
      selector:
        number:
          min: 0
          max: 120
          mode: box

    loop_delay_max:
      name: Delay Entre Loops MÃ¡ximo (min)
      description: Pausa mÃ¡xima entre repeticiones completas
      default: 15
      selector:
        number:
          min: 0
          max: 120
          mode: box

    transition_on:
      name: TransiciÃ³n Encendido (seg)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          mode: slider

    transition_off:
      name: TransiciÃ³n Apagado (seg)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ESCENAS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    enable_exit_scene:
      name: Activar Escena de Salida
      default: false
      selector:
        boolean:

    exit_scene:
      name: Escena de Salida Normal
      description: Se ejecuta al completar todos los loops
      default: []
      selector:
        entity:
          domain: scene

    emergency_scene:
      name: Escena de Parada de Emergencia
      description: Se ejecuta al detener manualmente
      default: []
      selector:
        entity:
          domain: scene

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # MONITOREO
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    enable_monitoring:
      name: Habilitar Monitoreo
      description: Actualiza helpers automÃ¡ticamente (requiere helpers configurados)
      default: true
      selector:
        boolean:

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
variables:
  automation_control_entity: !input automation_control_entity
  lights: !input lights
  max_lights_on: !input max_lights_on
  loop_count: !input loop_count
  time_on_min: !input time_on_min
  time_on_max: !input time_on_max
  delay_between_lights_min: !input delay_between_lights_min
  delay_between_lights_max: !input delay_between_lights_max
  loop_delay_min: !input loop_delay_min
  loop_delay_max: !input loop_delay_max
  transition_on: !input transition_on
  transition_off: !input transition_off
  enable_exit_scene: !input enable_exit_scene
  exit_scene: !input exit_scene
  emergency_scene: !input emergency_scene
  enable_monitoring: !input enable_monitoring

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRIGGER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trigger:
  - platform: state
    entity_id: !input automation_control_entity
    to: "on"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MODE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mode: single
max_exceeded: silent

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
action:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # INICIALIZACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - variables:
      lights_currently_on: []
      lights_with_timestamp: []
      loop_interrupted: false
      detener_manualmente: false

  # Actualizar helpers de inicio
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_monitoring }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.presence_simulation_running

          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.presence_simulation_start_time
            data:
              datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

          - service: input_number.set_value
            target:
              entity_id: input_number.presence_simulation_loop_counter
            data:
              value: 0

          - service: input_text.set_value
            target:
              entity_id: input_text.presence_simulation_status
            data:
              value: "Iniciando..."

  # Log de inicio
  - service: logbook.log
    data:
      name: "ğŸ  Presence Simulation v2.1"
      message: "Iniciando - {{ lights | length }} dispositivos, mÃ¡x {{ max_lights_on }} simultÃ¡neas, {{ loop_count }} loops"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # LOOP PRINCIPAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - repeat:
      count: "{{ loop_count if loop_count < 99 else 999 }}"
      sequence:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # VERIFICAR SI SE DETUVO
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - condition: state
          entity_id: !input automation_control_entity
          state: "on"

        # Actualizar contador de loop
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ enable_monitoring }}"
              sequence:
                - service: input_number.set_value
                  target:
                    entity_id: input_number.presence_simulation_loop_counter
                  data:
                    value: "{{ repeat.index }}"

                - service: input_text.set_value
                  target:
                    entity_id: input_text.presence_simulation_status
                  data:
                    value: "En ejecuciÃ³n - Loop {{ repeat.index }}"

        # Log de loop
        - service: logbook.log
          data:
            name: "ğŸ”„ Presence Simulation"
            message: "Loop {{ repeat.index }}/{{ loop_count }}"

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ENCENDER LUCES Y MANTENERLAS (LÃ“GICA CORREGIDA v2.1)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - repeat:
            for_each: "{{ lights }}"
            sequence:
              # Verificar si se detuvo
              - condition: state
                entity_id: !input automation_control_entity
                state: "on"

              - variables:
                  current_light: "{{ repeat.item }}"
                  current_domain: "{{ current_light.split('.')[0] }}"
                  needs_turn_off: "{{ lights_currently_on | length >= max_lights_on }}"
                  light_to_turn_off: >-
                    {% if lights_currently_on | length >= max_lights_on %}
                      {{ lights_currently_on[0] }}
                    {% else %}
                      null
                    {% endif %}

              # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              # â”‚ APAGAR LUZ MÃS ANTIGUA SI ALCANZAMOS EL LÃMITE             â”‚
              # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ needs_turn_off and light_to_turn_off != 'null' }}"
                    sequence:
                      - service: logbook.log
                        data:
                          name: "ğŸ”„ Presence Simulation"
                          message: "Rotando: apagando {{ state_attr(light_to_turn_off, 'friendly_name') or light_to_turn_off }}"

                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ light_to_turn_off.split('.')[0] == 'light' }}"
                            sequence:
                              - service: light.turn_off
                                target:
                                  entity_id: "{{ light_to_turn_off }}"
                                data:
                                  transition: "{{ transition_off }}"
                        default:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: "{{ light_to_turn_off }}"

                      - variables:
                          lights_currently_on: "{{ lights_currently_on[1:] | list }}"

                      # Actualizar monitoreo despuÃ©s de apagar
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ enable_monitoring }}"
                            sequence:
                              - service: input_number.set_value
                                target:
                                  entity_id: input_number.presence_simulation_lights_on_count
                                data:
                                  value: "{{ lights_currently_on | length }}"

              # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              # â”‚ ENCENDER LUZ NUEVA                                          â”‚
              # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ current_domain == 'light' }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: "{{ current_light }}"
                        data:
                          transition: "{{ transition_on }}"
                default:
                  - service: homeassistant.turn_on
                    target:
                      entity_id: "{{ current_light }}"

              - service: logbook.log
                data:
                  name: "ğŸ’¡ Presence Simulation"
                  message: "Encendida: {{ state_attr(current_light, 'friendly_name') or current_light }} ({{ lights_currently_on | length + 1 }}/{{ max_lights_on }})"

              # Agregar a lista de luces encendidas
              - variables:
                  lights_currently_on: "{{ lights_currently_on + [current_light] }}"

              # Actualizar monitoreo
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ enable_monitoring }}"
                    sequence:
                      - service: input_number.set_value
                        target:
                          entity_id: input_number.presence_simulation_lights_on_count
                        data:
                          value: "{{ lights_currently_on | length }}"

                      - service: input_text.set_value
                        target:
                          entity_id: input_text.presence_simulation_active_lights
                        data:
                          value: >-
                            {% set ns = namespace(names=[]) %}
                            {% for light in lights_currently_on %}
                              {% set name = state_attr(light, 'friendly_name') or light %}
                              {% set ns.names = ns.names + [name] %}
                            {% endfor %}
                            {{ ns.names | join(', ') if ns.names | length > 0 else 'Ninguna' }}

              # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              # â”‚ DELAY CORTO ANTES DE LA SIGUIENTE LUZ                       â”‚
              # â”‚ (NO apagamos la luz, la dejamos encendida)                  â”‚
              # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              - wait_template: "{{ is_state(automation_control_entity, 'off') }}"
                timeout:
                  seconds: "{{ range(delay_between_lights_min, delay_between_lights_max + 1) | random }}"

              # Si se detuvo durante el wait, marcar y salir
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: !input automation_control_entity
                        state: "off"
                    sequence:
                      - variables:
                          detener_manualmente: true
                      - stop: "Detenido manualmente"

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # MANTENER LUCES ENCENDIDAS DURANTE EL TIEMPO CONFIGURADO
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - service: logbook.log
          data:
            name: "â±ï¸  Presence Simulation"
            message: "Ciclo completo - {{ lights_currently_on | length }} luces encendidas durante {{ time_on_min }}-{{ time_on_max }} min"

        - wait_template: "{{ is_state(automation_control_entity, 'off') }}"
          timeout:
            minutes: "{{ range(time_on_min, time_on_max + 1) | random }}"

        # Verificar si se detuvo durante el tiempo de espera
        - choose:
            - conditions:
                - condition: state
                  entity_id: !input automation_control_entity
                  state: "off"
              sequence:
                - variables:
                    detener_manualmente: true
                - stop: "Detenido manualmente"

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # APAGAR TODAS LAS LUCES AL FINAL DEL LOOP
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ lights_currently_on | length > 0 }}"
              sequence:
                - service: logbook.log
                  data:
                    name: "ğŸŒ™ Presence Simulation"
                    message: "Finalizando loop - Apagando {{ lights_currently_on | length }} luces"

                - repeat:
                    for_each: "{{ lights_currently_on }}"
                    sequence:
                      - variables:
                          loop_light: "{{ repeat.item }}"
                          loop_domain: "{{ loop_light.split('.')[0] }}"

                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ loop_domain == 'light' }}"
                            sequence:
                              - service: light.turn_off
                                target:
                                  entity_id: "{{ loop_light }}"
                                data:
                                  transition: "{{ transition_off }}"
                        default:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: "{{ loop_light }}"

                      - delay:
                          milliseconds: 300

                - variables:
                    lights_currently_on: []

                # Actualizar monitoreo
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ enable_monitoring }}"
                      sequence:
                        - service: input_number.set_value
                          target:
                            entity_id: input_number.presence_simulation_lights_on_count
                          data:
                            value: 0

                        - service: input_text.set_value
                          target:
                            entity_id: input_text.presence_simulation_active_lights
                          data:
                            value: "Ninguna"

        # Delay entre loops
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ repeat.index < loop_count }}"
              sequence:
                - service: logbook.log
                  data:
                    name: "ğŸ’¤ Presence Simulation"
                    message: "Pausa entre loops ({{ loop_delay_min }}-{{ loop_delay_max }} min)"

                - delay:
                    minutes: "{{ range(loop_delay_min, loop_delay_max + 1) | random }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CLEANUP FINAL (se ejecuta SIEMPRE, termine como termine)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - alias: "Cleanup Final"
    choose:
      # Si hay luces encendidas, apagarlas
      - conditions:
          - condition: template
            value_template: "{{ lights_currently_on | length > 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸ§¹ Presence Simulation"
              message: "Limpieza final: {{ lights_currently_on | length }} luz(es)"

          - repeat:
              for_each: "{{ lights_currently_on }}"
              sequence:
                - variables:
                    cleanup_light: "{{ repeat.item }}"
                    cleanup_domain: "{{ cleanup_light.split('.')[0] }}"

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ cleanup_domain == 'light' }}"
                      sequence:
                        - service: light.turn_off
                          target:
                            entity_id: "{{ cleanup_light }}"
                          data:
                            transition: "{{ transition_off }}"
                  default:
                    - service: homeassistant.turn_off
                      target:
                        entity_id: "{{ cleanup_light }}"

                - delay:
                    milliseconds: 300

  # Limpiar helpers
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_monitoring }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.presence_simulation_running

          - service: input_number.set_value
            target:
              entity_id: input_number.presence_simulation_lights_on_count
            data:
              value: 0

          - service: input_text.set_value
            target:
              entity_id: input_text.presence_simulation_active_lights
            data:
              value: "Ninguna"

          - service: input_text.set_value
            target:
              entity_id: input_text.presence_simulation_status
            data:
              value: "Finalizada"

  # Ejecutar escena de salida
  - choose:
      # Si se detuvo manualmente y hay escena de emergencia
      - conditions:
          - condition: template
            value_template: "{{ detener_manualmente and emergency_scene | length > 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸ¬ Presence Simulation"
              message: "Escena de emergencia: {{ emergency_scene }}"

          - service: scene.turn_on
            target:
              entity_id: "{{ emergency_scene }}"

      # Si terminÃ³ normalmente y hay escena de salida
      - conditions:
          - condition: template
            value_template: "{{ enable_exit_scene and exit_scene | length > 0 and not detener_manualmente }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸ¬ Presence Simulation"
              message: "Escena de salida: {{ exit_scene }}"

          - service: scene.turn_on
            target:
              entity_id: "{{ exit_scene }}"

  # Log final
  - service: logbook.log
    data:
      name: "âœ… Presence Simulation v2.1"
      message: "Finalizada - Todas las luces apagadas"
