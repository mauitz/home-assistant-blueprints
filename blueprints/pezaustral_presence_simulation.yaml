blueprint:
  name: PezAustral Presence Simulation v2.2
  description: >
    # üè† Simulaci√≥n de Presencia Inteligente

    **VERSI√ìN 2.2 - NUEVAS FUNCIONES UX**

    ‚úÖ **NUEVO v2.2** - Funci√≥n PAUSE/RESUME (pausar sin apagar luces)
    ‚úÖ **NUEVO v2.2** - Sistema de notificaciones configurable
    ‚úÖ **MEJORADO** - Mantiene m√∫ltiples luces encendidas simult√°neamente
    ‚úÖ **CLEANUP AUTOM√ÅTICO** - Apaga TODAS las luces al detener
    ‚úÖ **MONITOREO INTEGRADO** - Actualiza contadores autom√°ticamente
    ‚úÖ **DETENCI√ìN LIMPIA** - Se puede detener en cualquier momento
    ‚úÖ **ESCENAS DE SALIDA** - Configurables para fin normal o emergencia
    ‚úÖ **CONTROL DE L√ÅMPARAS** - M√°ximo simult√°neas configurable
    ‚úÖ **LOGS DETALLADOS** - Tracking completo en Logbook

    **CAMBIOS v2.2:**
    - ‚è∏Ô∏è PAUSE/RESUME: Pausar simulaci√≥n manteniendo luces encendidas
    - üì± Notificaciones: Sistema de alertas configurable (inicio/stop/completado)
    - üé® Mejor UX: Control mejorado en dashboard

    **Documentaci√≥n:** https://github.com/mauitz/home-assistant-blueprints

  domain: automation
  source_url: https://github.com/mauitz/home-assistant-blueprints/blob/main/blueprints/pezaustral_presence_simulation.yaml

  input:
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # CONTROL
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    automation_control_entity:
      name: Entidad de Control *
      description: Input boolean para activar/desactivar la simulaci√≥n
      selector:
        entity:
          domain: input_boolean

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # LUCES
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    lights:
      name: Luces/Switches *
      description: Dispositivos que se encender√°n/apagar√°n
      selector:
        entity:
          domain: [light, switch]
          multiple: true

    max_lights_on:
      name: M√°ximo Simult√°neas
      description: M√°ximo de luces encendidas al mismo tiempo
      default: 2
      selector:
        number:
          min: 1
          max: 20
          mode: slider

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # TIMING
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    loop_count:
      name: Loops
      description: N√∫mero de repeticiones (99 = infinito)
      default: 10
      selector:
        number:
          min: 0
          max: 99
          mode: box

    time_on_min:
      name: Tiempo Encendido M√≠nimo (min)
      description: Cada luz permanecer√° encendida al menos este tiempo
      default: 15
      selector:
        number:
          min: 1
          max: 240
          mode: box

    time_on_max:
      name: Tiempo Encendido M√°ximo (min)
      description: Cada luz permanecer√° encendida como m√°ximo este tiempo
      default: 45
      selector:
        number:
          min: 1
          max: 240
          mode: box

    delay_between_lights_min:
      name: Delay Entre Luces M√≠nimo (seg)
      description: Tiempo m√≠nimo de espera antes de encender la siguiente luz
      default: 10
      selector:
        number:
          min: 1
          max: 300
          mode: box

    delay_between_lights_max:
      name: Delay Entre Luces M√°ximo (seg)
      description: Tiempo m√°ximo de espera antes de encender la siguiente luz
      default: 60
      selector:
        number:
          min: 1
          max: 300
          mode: box

    loop_delay_min:
      name: Delay Entre Loops M√≠nimo (min)
      description: Pausa entre repeticiones completas
      default: 5
      selector:
        number:
          min: 0
          max: 120
          mode: box

    loop_delay_max:
      name: Delay Entre Loops M√°ximo (min)
      description: Pausa m√°xima entre repeticiones completas
      default: 15
      selector:
        number:
          min: 0
          max: 120
          mode: box

    transition_on:
      name: Transici√≥n Encendido (seg)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          mode: slider

    transition_off:
      name: Transici√≥n Apagado (seg)
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          mode: slider

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # ESCENAS
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    enable_exit_scene:
      name: Activar Escena de Salida
      default: false
      selector:
        boolean:

    exit_scene:
      name: Escena de Salida Normal
      description: Se ejecuta al completar todos los loops
      default: []
      selector:
        entity:
          domain: scene

    emergency_scene:
      name: Escena de Parada de Emergencia
      description: Se ejecuta al detener manualmente
      default: []
      selector:
        entity:
          domain: scene

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # MONITOREO
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    enable_monitoring:
      name: Habilitar Monitoreo
      description: Actualiza helpers autom√°ticamente (requiere helpers configurados)
      default: true
      selector:
        boolean:

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # NOTIFICACIONES (v2.2)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    enable_notifications:
      name: Habilitar Notificaciones
      description: Enviar notificaciones al iniciar, detener o completar
      default: false
      selector:
        boolean:

    notification_service:
      name: Servicio de Notificaci√≥n
      description: "Ejemplo: notify.mobile_app_blacky o notify.persistent_notification"
      default: ""
      selector:
        text:

    notify_on_start:
      name: Notificar al Iniciar
      default: true
      selector:
        boolean:

    notify_on_stop:
      name: Notificar al Detener
      default: true
      selector:
        boolean:

    notify_on_complete:
      name: Notificar al Completar
      default: true
      selector:
        boolean:

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# VARIABLES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
variables:
  automation_control_entity: !input automation_control_entity
  lights: !input lights
  max_lights_on: !input max_lights_on
  loop_count: !input loop_count
  time_on_min: !input time_on_min
  time_on_max: !input time_on_max
  delay_between_lights_min: !input delay_between_lights_min
  delay_between_lights_max: !input delay_between_lights_max
  loop_delay_min: !input loop_delay_min
  loop_delay_max: !input loop_delay_max
  transition_on: !input transition_on
  transition_off: !input transition_off
  enable_exit_scene: !input enable_exit_scene
  exit_scene: !input exit_scene
  emergency_scene: !input emergency_scene
  enable_monitoring: !input enable_monitoring
  enable_notifications: !input enable_notifications
  notification_service: !input notification_service
  notify_on_start: !input notify_on_start
  notify_on_stop: !input notify_on_stop
  notify_on_complete: !input notify_on_complete

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TRIGGER
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
trigger:
  - platform: state
    entity_id: !input automation_control_entity
    to: "on"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# MODE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
mode: single
max_exceeded: silent

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ACTION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
action:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # INICIALIZACI√ìN
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - variables:
      lights_currently_on: []
      lights_with_timestamp: []
      loop_interrupted: false
      detener_manualmente: false

  # Actualizar helpers de inicio
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_monitoring }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.presence_simulation_running

          - service: input_datetime.set_datetime
            target:
              entity_id: input_datetime.presence_simulation_start_time
            data:
              datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

          - service: input_number.set_value
            target:
              entity_id: input_number.presence_simulation_loop_counter
            data:
              value: 0

          - service: input_text.set_value
            target:
              entity_id: input_text.presence_simulation_status
            data:
              value: "Iniciando..."

  # Log de inicio
  - service: logbook.log
    data:
      name: "üè† Presence Simulation v2.2"
      message: "Iniciando - {{ lights | length }} dispositivos, m√°x {{ max_lights_on }} simult√°neas, {{ loop_count }} loops"

  # Notificaci√≥n de inicio (v2.2)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_notifications and notify_on_start and notification_service | length > 0 }}"
        sequence:
          - service: "{{ notification_service }}"
            data:
              title: "üè† Simulaci√≥n Iniciada"
              message: |
                {{ lights | length }} dispositivos configurados
                M√°ximo simult√°neas: {{ max_lights_on }}
                Loops: {{ loop_count if loop_count < 99 else '‚àû Infinito' }}
              data:
                tag: presence_simulation
                group: presence_simulation

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # LOOP PRINCIPAL
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - repeat:
      count: "{{ loop_count if loop_count < 99 else 999 }}"
      sequence:
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # VERIFICAR SI SE DETUVO
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - condition: state
          entity_id: !input automation_control_entity
          state: "on"

        # Actualizar contador de loop
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ enable_monitoring }}"
              sequence:
                - service: input_number.set_value
                  target:
                    entity_id: input_number.presence_simulation_loop_counter
                  data:
                    value: "{{ repeat.index }}"

                - service: input_text.set_value
                  target:
                    entity_id: input_text.presence_simulation_status
                  data:
                    value: "En ejecuci√≥n - Loop {{ repeat.index }}"

        # Log de loop
        - service: logbook.log
          data:
            name: "üîÑ Presence Simulation"
            message: "Loop {{ repeat.index }}/{{ loop_count }}"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # ENCENDER LUCES Y MANTENERLAS (L√ìGICA CORREGIDA v2.1)
        # ORDEN ALEATORIO (v2.2)
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - variables:
            shuffled_lights: "{{ lights | shuffle | list }}"

        - repeat:
            for_each: "{{ shuffled_lights }}"
            sequence:
              # Verificar si se detuvo
              - condition: state
                entity_id: !input automation_control_entity
                state: "on"

              - variables:
                  current_light: "{{ repeat.item }}"
                  current_domain: "{{ current_light.split('.')[0] }}"
                  needs_turn_off: "{{ lights_currently_on | length >= max_lights_on }}"
                  light_to_turn_off: >-
                    {% if lights_currently_on | length >= max_lights_on %}
                      {{ lights_currently_on[0] }}
                    {% else %}
                      null
                    {% endif %}

              # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              # ‚îÇ APAGAR LUZ M√ÅS ANTIGUA SI ALCANZAMOS EL L√çMITE             ‚îÇ
              # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ needs_turn_off and light_to_turn_off != 'null' }}"
                    sequence:
                      - service: logbook.log
                        data:
                          name: "üîÑ Presence Simulation"
                          message: "Rotando: apagando {{ state_attr(light_to_turn_off, 'friendly_name') or light_to_turn_off }}"

                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ light_to_turn_off.split('.')[0] == 'light' }}"
                            sequence:
                              - service: light.turn_off
                                target:
                                  entity_id: "{{ light_to_turn_off }}"
                                data:
                                  transition: "{{ transition_off }}"
                        default:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: "{{ light_to_turn_off }}"

                      - variables:
                          lights_currently_on: "{{ lights_currently_on[1:] | list }}"

                      # Actualizar monitoreo despu√©s de apagar
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ enable_monitoring }}"
                            sequence:
                              - service: input_number.set_value
                                target:
                                  entity_id: input_number.presence_simulation_lights_on_count
                                data:
                                  value: "{{ lights_currently_on | length }}"

              # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              # ‚îÇ ENCENDER LUZ NUEVA                                          ‚îÇ
              # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ current_domain == 'light' }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: "{{ current_light }}"
                        data:
                          transition: "{{ transition_on }}"
                default:
                  - service: homeassistant.turn_on
                    target:
                      entity_id: "{{ current_light }}"

              - service: logbook.log
                data:
                  name: "üí° Presence Simulation"
                  message: "Encendida: {{ state_attr(current_light, 'friendly_name') or current_light }} ({{ lights_currently_on | length + 1 }}/{{ max_lights_on }})"

              # Agregar a lista de luces encendidas
              - variables:
                  lights_currently_on: "{{ lights_currently_on + [current_light] }}"

              # Actualizar monitoreo
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ enable_monitoring }}"
                    sequence:
                      - service: input_number.set_value
                        target:
                          entity_id: input_number.presence_simulation_lights_on_count
                        data:
                          value: "{{ lights_currently_on | length }}"

                      - service: input_text.set_value
                        target:
                          entity_id: input_text.presence_simulation_active_lights
                        data:
                          value: >-
                            {% set ns = namespace(names=[]) %}
                            {% for light in lights_currently_on %}
                              {% set name = state_attr(light, 'friendly_name') or light %}
                              {% set ns.names = ns.names + [name] %}
                            {% endfor %}
                            {{ ns.names | join(', ') if ns.names | length > 0 else 'Ninguna' }}

              # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              # ‚îÇ DELAY CORTO ANTES DE LA SIGUIENTE LUZ                       ‚îÇ
              # ‚îÇ (NO apagamos la luz, la dejamos encendida)                  ‚îÇ
              # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              - wait_template: |
                  {{ is_state(automation_control_entity, 'off') or
                     is_state('input_boolean.presence_simulation_paused', 'on') }}
                timeout:
                  seconds: "{{ range(delay_between_lights_min, delay_between_lights_max + 1) | random }}"

              # Detectar pausa o detenci√≥n (v2.2)
              - choose:
                  # ‚ïê‚ïê‚ïê PAUSA DETECTADA ‚ïê‚ïê‚ïê
                  - conditions:
                      - condition: state
                        entity_id: input_boolean.presence_simulation_paused
                        state: "on"
                    sequence:
                      - service: logbook.log
                        data:
                          name: "‚è∏Ô∏è Presence Simulation v2.2"
                          message: "PAUSADA - {{ lights_currently_on | length }} luces manteni√©ndose encendidas"

                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ enable_monitoring }}"
                            sequence:
                              - service: input_text.set_value
                                target:
                                  entity_id: input_text.presence_simulation_status
                                data:
                                  value: "‚è∏Ô∏è En pausa - {{ lights_currently_on | length }} luces encendidas"

                      # Esperar hasta resume o stop
                      - wait_template: |
                          {{ is_state(automation_control_entity, 'off') or
                             is_state('input_boolean.presence_simulation_paused', 'off') }}

                      # Verificar si se resumi√≥ o se detuvo
                      - choose:
                          # Si se detuvo durante la pausa
                          - conditions:
                              - condition: state
                                entity_id: !input automation_control_entity
                                state: "off"
                            sequence:
                              - variables:
                                  detener_manualmente: true
                              - stop: "Detenido durante pausa"

                          # Si se resumi√≥
                          - conditions:
                              - condition: state
                                entity_id: input_boolean.presence_simulation_paused
                                state: "off"
                              - condition: state
                                entity_id: !input automation_control_entity
                                state: "on"
                            sequence:
                              - service: logbook.log
                                data:
                                  name: "‚ñ∂Ô∏è Presence Simulation v2.2"
                                  message: "RESUMIDA - Continuando desde pausa"

                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ enable_monitoring }}"
                                    sequence:
                                      - service: input_text.set_value
                                        target:
                                          entity_id: input_text.presence_simulation_status
                                        data:
                                          value: "En ejecuci√≥n - Loop {{ repeat.index }}"

                  # ‚ïê‚ïê‚ïê DETENCI√ìN MANUAL ‚ïê‚ïê‚ïê
                  - conditions:
                      - condition: state
                        entity_id: !input automation_control_entity
                        state: "off"
                    sequence:
                      - variables:
                          detener_manualmente: true
                      - stop: "Detenido manualmente"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # MANTENER LUCES ENCENDIDAS DURANTE EL TIEMPO CONFIGURADO
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - service: logbook.log
          data:
            name: "‚è±Ô∏è  Presence Simulation v2.2"
            message: "Ciclo completo - {{ lights_currently_on | length }} luces encendidas durante {{ time_on_min }}-{{ time_on_max }} min"

        - wait_template: |
            {{ is_state(automation_control_entity, 'off') or
               is_state('input_boolean.presence_simulation_paused', 'on') }}
          timeout:
            minutes: "{{ range(time_on_min, time_on_max + 1) | random }}"

        # Verificar si se paus√≥ o detuvo durante el tiempo de espera (v2.2)
        - choose:
            # ‚ïê‚ïê‚ïê PAUSA DETECTADA ‚ïê‚ïê‚ïê
            - conditions:
                - condition: state
                  entity_id: input_boolean.presence_simulation_paused
                  state: "on"
              sequence:
                - service: logbook.log
                  data:
                    name: "‚è∏Ô∏è Presence Simulation v2.2"
                    message: "PAUSADA durante mantenimiento - {{ lights_currently_on | length }} luces encendidas"

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ enable_monitoring }}"
                      sequence:
                        - service: input_text.set_value
                          target:
                            entity_id: input_text.presence_simulation_status
                          data:
                            value: "‚è∏Ô∏è En pausa - {{ lights_currently_on | length }} luces encendidas"

                # Esperar hasta resume o stop
                - wait_template: |
                    {{ is_state(automation_control_entity, 'off') or
                       is_state('input_boolean.presence_simulation_paused', 'off') }}

                # Verificar qu√© pas√≥
                - choose:
                    # Si se detuvo durante la pausa
                    - conditions:
                        - condition: state
                          entity_id: !input automation_control_entity
                          state: "off"
                      sequence:
                        - variables:
                            detener_manualmente: true
                        - stop: "Detenido durante pausa"

                    # Si se resumi√≥
                    - conditions:
                        - condition: state
                          entity_id: input_boolean.presence_simulation_paused
                          state: "off"
                        - condition: state
                          entity_id: !input automation_control_entity
                          state: "on"
                      sequence:
                        - service: logbook.log
                          data:
                            name: "‚ñ∂Ô∏è Presence Simulation v2.2"
                            message: "RESUMIDA - Continuando loop"

                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ enable_monitoring }}"
                              sequence:
                                - service: input_text.set_value
                                  target:
                                    entity_id: input_text.presence_simulation_status
                                  data:
                                    value: "En ejecuci√≥n - Loop {{ repeat.index }}"

            # ‚ïê‚ïê‚ïê DETENCI√ìN MANUAL ‚ïê‚ïê‚ïê
            - conditions:
                - condition: state
                  entity_id: !input automation_control_entity
                  state: "off"
              sequence:
                - variables:
                    detener_manualmente: true
                - stop: "Detenido manualmente"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # APAGAR TODAS LAS LUCES AL FINAL DEL LOOP
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ lights_currently_on | length > 0 }}"
              sequence:
                - service: logbook.log
                  data:
                    name: "üåô Presence Simulation"
                    message: "Finalizando loop - Apagando {{ lights_currently_on | length }} luces"

                - repeat:
                    for_each: "{{ lights_currently_on }}"
                    sequence:
                      - variables:
                          loop_light: "{{ repeat.item }}"
                          loop_domain: "{{ loop_light.split('.')[0] }}"

                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ loop_domain == 'light' }}"
                            sequence:
                              - service: light.turn_off
                                target:
                                  entity_id: "{{ loop_light }}"
                                data:
                                  transition: "{{ transition_off }}"
                        default:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: "{{ loop_light }}"

                      - delay:
                          milliseconds: 300

                - variables:
                    lights_currently_on: []

                # Actualizar monitoreo
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ enable_monitoring }}"
                      sequence:
                        - service: input_number.set_value
                          target:
                            entity_id: input_number.presence_simulation_lights_on_count
                          data:
                            value: 0

                        - service: input_text.set_value
                          target:
                            entity_id: input_text.presence_simulation_active_lights
                          data:
                            value: "Ninguna"

        # Delay entre loops
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ repeat.index < loop_count }}"
              sequence:
                - service: logbook.log
                  data:
                    name: "üí§ Presence Simulation"
                    message: "Pausa entre loops ({{ loop_delay_min }}-{{ loop_delay_max }} min)"

                - delay:
                    minutes: "{{ range(loop_delay_min, loop_delay_max + 1) | random }}"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # CLEANUP FINAL (se ejecuta SIEMPRE, termine como termine)
  # APAGA TODAS LAS LUCES CONFIGURADAS (no solo las encendidas)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  - alias: "Cleanup Final"
    sequence:
      - service: logbook.log
        data:
          name: "üßπ Presence Simulation v2.2"
          message: "Limpieza final: Apagando TODAS las luces configuradas ({{ lights | length }} dispositivos)"

      # Apagar TODAS las luces de la configuraci√≥n
      - repeat:
          for_each: "{{ lights }}"
          sequence:
            - variables:
                cleanup_light: "{{ repeat.item }}"
                cleanup_domain: "{{ cleanup_light.split('.')[0] }}"

            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ cleanup_domain == 'light' }}"
                  sequence:
                    - service: light.turn_off
                      target:
                        entity_id: "{{ cleanup_light }}"
                      data:
                        transition: "{{ transition_off }}"
              default:
                - service: homeassistant.turn_off
                  target:
                    entity_id: "{{ cleanup_light }}"

            - delay:
                milliseconds: 300

  # Limpiar helpers
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_monitoring }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.presence_simulation_running

          - service: input_number.set_value
            target:
              entity_id: input_number.presence_simulation_lights_on_count
            data:
              value: 0

          - service: input_text.set_value
            target:
              entity_id: input_text.presence_simulation_active_lights
            data:
              value: "Ninguna"

          - service: input_text.set_value
            target:
              entity_id: input_text.presence_simulation_status
            data:
              value: "Finalizada"

  # Ejecutar escena de salida
  - choose:
      # Si se detuvo manualmente y hay escena de emergencia
      - conditions:
          - condition: template
            value_template: "{{ detener_manualmente and emergency_scene | length > 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: "üé¨ Presence Simulation"
              message: "Escena de emergencia: {{ emergency_scene }}"

          - service: scene.turn_on
            target:
              entity_id: "{{ emergency_scene }}"

      # Si termin√≥ normalmente y hay escena de salida
      - conditions:
          - condition: template
            value_template: "{{ enable_exit_scene and exit_scene | length > 0 and not detener_manualmente }}"
        sequence:
          - service: logbook.log
            data:
              name: "üé¨ Presence Simulation"
              message: "Escena de salida: {{ exit_scene }}"

          - service: scene.turn_on
            target:
              entity_id: "{{ exit_scene }}"

  # Notificaci√≥n de stop/completado (v2.2)
  - choose:
      # Notificaci√≥n de DETENCI√ìN MANUAL
      - conditions:
          - condition: template
            value_template: "{{ enable_notifications and notify_on_stop and notification_service | length > 0 and detener_manualmente }}"
        sequence:
          - service: "{{ notification_service }}"
            data:
              title: "‚èπÔ∏è Simulaci√≥n Detenida"
              message: |
                Detenida manualmente
                Loops completados: {{ states('input_number.presence_simulation_loop_counter') | int(0) }}/{{ loop_count if loop_count < 99 else '‚àû' }}
                Todas las luces apagadas
              data:
                tag: presence_simulation
                group: presence_simulation

      # Notificaci√≥n de COMPLETADO NORMAL
      - conditions:
          - condition: template
            value_template: "{{ enable_notifications and notify_on_complete and notification_service | length > 0 and not detener_manualmente }}"
        sequence:
          - service: "{{ notification_service }}"
            data:
              title: "‚úÖ Simulaci√≥n Completada"
              message: |
                Todos los loops completados exitosamente
                Loops: {{ loop_count }}
                Dispositivos: {{ lights | length }}
                {% set runtime = states('sensor.presence_simulation_runtime') %}
                {% if runtime not in ['unknown', 'unavailable', 'Inactiva'] %}
                Tiempo total: {{ runtime }}
                {% endif %}
              data:
                tag: presence_simulation
                group: presence_simulation

  # Log final
  - service: logbook.log
    data:
      name: "‚úÖ Presence Simulation v2.2"
      message: "Finalizada - Todas las luces apagadas"
