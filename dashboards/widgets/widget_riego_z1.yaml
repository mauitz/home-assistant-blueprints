# ============================================
# WIDGET DE RIEGO INTELIGENTE - ZONA 1
# ============================================
# Widget especializado para monitorear y controlar
# el sistema de riego autom√°tico de la Zona 1
#
# Caracter√≠sticas:
# - Estado de sensores en tiempo real
# - Control de bombas con un toque
# - Gr√°fico de humedad hist√≥rico
# - Indicadores visuales de estado
# - Temporizador de riego activo
# - Modo manual/autom√°tico
# ============================================

type: vertical-stack
cards:
  # ==========================================
  # CABECERA - Estado General
  # ==========================================
  - type: custom:mushroom-template-card
    primary: "üö∞ Sistema de Riego - Zona 1"
    secondary: >
      {% set humedad = states('sensor.humedad_suelo_z1') | float(0) %}
      {% set tanque = states('sensor.nivel_tanque') | float(0) %}
      {% set bomba_a = is_state('switch.bomba_z1a', 'on') %}
      {% set bomba_b = is_state('switch.bomba_z1b', 'on') %}
      
      {% if bomba_a or bomba_b %}
        üíß Regando ahora | Humedad: {{ humedad }}%
      {% elif tanque < 20 %}
        ‚ö†Ô∏è Tanque Bajo ({{ tanque }}%) | Sistema detenido
      {% elif humedad < 30 %}
        üåµ Suelo seco ({{ humedad }}%) | Esperando horario
      {% else %}
        ‚úÖ Sistema OK | Humedad: {{ humedad }}% | Tanque: {{ tanque }}%
      {% endif %}
    icon: >
      {% set bomba_a = is_state('switch.bomba_z1a', 'on') %}
      {% set bomba_b = is_state('switch.bomba_z1b', 'on') %}
      {% if bomba_a or bomba_b %}
        mdi:water-pump
      {% else %}
        mdi:sprinkler-variant
      {% endif %}
    icon_color: >
      {% set bomba_a = is_state('switch.bomba_z1a', 'on') %}
      {% set bomba_b = is_state('switch.bomba_z1b', 'on') %}
      {% set humedad = states('sensor.humedad_suelo_z1') | float(100) %}
      {% set tanque = states('sensor.nivel_tanque') | float(0) %}
      
      {% if bomba_a or bomba_b %}
        blue
      {% elif tanque < 20 %}
        red
      {% elif humedad < 30 %}
        orange
      {% else %}
        green
      {% endif %}
    tap_action:
      action: more-info
      entity: sensor.humedad_suelo_z1
    badge_icon: >
      {% if is_state('input_boolean.riego_z1_manual', 'on') %}
        mdi:hand-back-right
      {% endif %}
    badge_color: amber

  # ==========================================
  # SENSORES PRINCIPALES
  # ==========================================
  - type: horizontal-stack
    cards:
      # Humedad del Suelo
      - type: custom:mushroom-entity-card
        entity: sensor.humedad_suelo_z1
        name: Humedad Suelo
        icon: mdi:water-percent
        icon_color: >
          {% set humedad = states('sensor.humedad_suelo_z1') | float(0) %}
          {% if humedad < 30 %}
            red
          {% elif humedad < 50 %}
            orange
          {% elif humedad < 70 %}
            green
          {% else %}
            blue
          {% endif %}
        tap_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.03);
            }
      
      # Nivel del Tanque
      - type: custom:mushroom-entity-card
        entity: sensor.nivel_tanque
        name: Tanque
        icon: mdi:water-well
        icon_color: >
          {% set tanque = states('sensor.nivel_tanque') | float(0) %}
          {% if tanque < 20 %}
            red
          {% elif tanque < 50 %}
            orange
          {% else %}
            green
          {% endif %}
        tap_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.03);
            }
      
      # Luz Ambiente
      - type: custom:mushroom-entity-card
        entity: sensor.luz_ambiente
        name: Luz
        icon: mdi:weather-sunny
        icon_color: >
          {% set luz = states('sensor.luz_ambiente') | float(0) %}
          {% if luz < 10 %}
            grey
          {% elif luz < 50 %}
            amber
          {% else %}
            yellow
          {% endif %}
        tap_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.03);
            }

  # ==========================================
  # GR√ÅFICO DE HUMEDAD
  # ==========================================
  - type: custom:mini-graph-card
    entities:
      - entity: sensor.humedad_suelo_z1
        name: Humedad Suelo
        color: '#03a9f4'
        show_state: true
        show_indicator: true
    name: üìä Humedad de las √∫ltimas 24 horas
    hours_to_show: 24
    points_per_hour: 2
    line_width: 3
    font_size: 75
    animate: true
    show:
      labels: true
      labels_secondary: true
      fill: fade
      icon: false
      name: true
      state: true
    color_thresholds:
      - value: 0
        color: "#f44336"
      - value: 30
        color: "#ff9800"
      - value: 50
        color: "#4caf50"
      - value: 70
        color: "#03a9f4"

  # ==========================================
  # CONTROLES DE BOMBAS
  # ==========================================
  - type: horizontal-stack
    cards:
      # Bomba Z1A
      - type: custom:mushroom-entity-card
        entity: switch.bomba_z1a
        name: Bomba Z1A
        icon: mdi:water-pump
        icon_color: blue
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: {% if is_state('switch.bomba_z1a', 'on') %}
                rgba(3, 169, 244, 0.15)
              {% else %}
                rgba(var(--rgb-primary-text-color), 0.03)
              {% endif %};
            }
      
      # Bomba Z1B
      - type: custom:mushroom-entity-card
        entity: switch.bomba_z1b
        name: Bomba Z1B
        icon: mdi:water-pump
        icon_color: blue
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: {% if is_state('switch.bomba_z1b', 'on') %}
                rgba(3, 169, 244, 0.15)
              {% else %}
                rgba(var(--rgb-primary-text-color), 0.03)
              {% endif %};
            }
      
      # LED Indicador
      - type: custom:mushroom-entity-card
        entity: light.led_bomba
        name: LED Bomba
        icon: mdi:led-on
        icon_color: amber
        tap_action:
          action: none
        card_mod:
          style: |
            ha-card {
              background: {% if is_state('light.led_bomba', 'on') %}
                rgba(255, 193, 7, 0.15)
              {% else %}
                rgba(var(--rgb-primary-text-color), 0.03)
              {% endif %};
            }

  # ==========================================
  # INFORMACI√ìN DE SENSORES AMBIENTALES
  # ==========================================
  - type: horizontal-stack
    cards:
      # Temperatura Ambiente
      - type: custom:mushroom-entity-card
        entity: sensor.temperatura_ambiente
        name: Temperatura
        icon: mdi:thermometer
        icon_color: >
          {% set temp = states('sensor.temperatura_ambiente') | float(0) %}
          {% if temp < 15 %}
            blue
          {% elif temp < 25 %}
            green
          {% elif temp < 30 %}
            orange
          {% else %}
            red
          {% endif %}
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.03);
            }
      
      # Humedad Ambiente
      - type: custom:mushroom-entity-card
        entity: sensor.humedad_ambiente
        name: H. Ambiente
        icon: mdi:water-percent
        icon_color: blue
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.03);
            }
      
      # Presencia
      - type: custom:mushroom-entity-card
        entity: binary_sensor.presencia_detectada
        name: Presencia
        icon: mdi:motion-sensor
        icon_color: >
          {% if is_state('binary_sensor.presencia_detectada', 'on') %}
            amber
          {% else %}
            grey
          {% endif %}
        card_mod:
          style: |
            ha-card {
              background: rgba(var(--rgb-primary-text-color), 0.03);
            }

  # ==========================================
  # MODO MANUAL Y CONFIGURACI√ìN
  # ==========================================
  - type: entities
    title: ‚öôÔ∏è Control y Configuraci√≥n
    show_header_toggle: false
    card_mod:
      style: |
        ha-card {
          background: rgba(var(--rgb-primary-text-color), 0.05);
          border-radius: 12px;
        }
    entities:
      - entity: input_boolean.riego_z1_manual
        name: Modo Manual
        icon: mdi:hand-back-right
        secondary_info: >
          {% if is_state('input_boolean.riego_z1_manual', 'on') %}
            Automatizaci√≥n desactivada
          {% else %}
            Riego autom√°tico activo
          {% endif %}
      
      - type: divider
      
      - entity: sensor.riego_z1_estado_sistema
        name: Estado del Sistema
        icon: mdi:state-machine
      
      - entity: sensor.riego_z1_tiempo_desde_ultimo
        name: √öltimo Riego
        icon: mdi:clock-outline
      
      - type: divider
      
      - type: custom:mushroom-chips-card
        chips:
          # Chip: Riego Manual 5 min
          - type: action
            icon: mdi:timer-10
            icon_color: blue
            tap_action:
              action: call-service
              service: script.riego_manual_5min
            hold_action:
              action: none
          
          # Chip: Detener Todo
          - type: action
            icon: mdi:stop-circle
            icon_color: red
            tap_action:
              action: call-service
              service: script.detener_todas_bombas
            hold_action:
              action: none
          
          # Chip: Informaci√≥n
          - type: template
            icon: mdi:information
            icon_color: grey
            content: >
              {% set bomba_a = is_state('switch.bomba_z1a', 'on') %}
              {% set bomba_b = is_state('switch.bomba_z1b', 'on') %}
              {% if bomba_a or bomba_b %}
                ON
              {% else %}
                OFF
              {% endif %}
            tap_action:
              action: fire-dom-event
              browser_mod:
                service: browser_mod.popup
                data:
                  title: "Sistema de Riego Z1"
                  content:
                    type: markdown
                    content: |
                      ## üìä Estado Actual
                      
                      **Humedad Suelo:** {{ states('sensor.humedad_suelo_z1') }}%
                      **Nivel Tanque:** {{ states('sensor.nivel_tanque') }}%
                      **Luz Ambiente:** {{ states('sensor.luz_ambiente') }}%
                      **Temperatura:** {{ states('sensor.temperatura_ambiente') }}¬∞C
                      
                      ---
                      
                      ## üíß Bombas
                      
                      **Z1A:** {{ states('switch.bomba_z1a') }}
                      **Z1B:** {{ states('switch.bomba_z1b') }}
                      
                      ---
                      
                      ## ‚öôÔ∏è Configuraci√≥n
                      
                      - Humedad m√≠nima: 30%
                      - Humedad objetivo: 60%
                      - Duraci√≥n m√°xima: 10 min
                      - Nivel m√≠nimo tanque: 20%

  # ==========================================
  # ACCIONES R√ÅPIDAS
  # ==========================================
  - type: custom:mushroom-chips-card
    chips:
      # Regar Ahora
      - type: action
        icon: mdi:water-pump
        icon_color: blue
        tap_action:
          action: call-service
          service: switch.turn_on
          service_data:
            entity_id: switch.bomba_z1a
        hold_action:
          action: call-service
          service: switch.turn_off
          service_data:
            entity_id: switch.bomba_z1a
      
      # Ver Automatizaci√≥n
      - type: entity
        entity: automation.riego_automatico_zona_1
        icon: mdi:robot
        icon_color: green
        tap_action:
          action: more-info
      
      # Ver Historia
      - type: action
        icon: mdi:history
        icon_color: grey
        tap_action:
          action: navigate
          navigation_path: /history?entity_id=sensor.humedad_suelo_z1
      
      # Configuraci√≥n
      - type: action
        icon: mdi:cog
        icon_color: grey
        tap_action:
          action: navigate
          navigation_path: /config/automation

card_mod:
  style: |
    ha-card {
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

